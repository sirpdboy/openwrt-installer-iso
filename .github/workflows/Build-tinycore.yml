name: Build-tinycore

on:
  push:
    branches: [ main, master ]
    paths:
      - './build-tinycore.sh'
      - '.github/workflows/Build-tinycore.yml'
  workflow_dispatch:
    inputs:
      img_file:
        description: 'OpenWRT IMGæ–‡ä»¶URL'
        required: true
        default: 'https://downloads.openwrt.org/releases/23.05.3/targets/x86/64/openwrt-23.05.3-x86-64-generic-ext4-combined-efi.img.gz'
      output_name:
        description: 'è¾“å‡ºISOæ–‡ä»¶å'
        required: false
        default: 'openwrt-installer'

env:
  tinycore_VERSION: "13.0"

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€æŸ¥ç¯å¢ƒ
      run: |
        echo "tinycoreç‰ˆæœ¬: ${{ env.tinycore_VERSION }}"
        echo "IMGæ–‡ä»¶: ${{ github.event.inputs.img_file }}"
        echo "è¾“å‡ºåç§°: ${{ github.event.inputs.output_name }}"
        
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      
    - name: å‡†å¤‡Dockeræ„å»ºç¯å¢ƒ
      run: |
        cat > Dockerfile.openwrt-builder << 'DOCKEREOF'
        FROM ubuntu:22.04

        # å®‰è£…æ„å»ºå·¥å…·ï¼ˆä¿®å¤åŒ…åï¼‰
        RUN apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y \
        genisoimage \
        syslinux \
        isolinux \
        squashfs-tools \
        pv \
        xorriso \
        mtools \
        dosfstools \
        # grubç›¸å…³åŒ… - ä½¿ç”¨æ­£ç¡®çš„åŒ…å
        grub-pc-bin \
        grub-efi-amd64-bin \
        grub-efi-ia32-bin \
        grub2-common \
        wget \
        curl \
        xz-utils \          # åŒ…åä» xz æ”¹ä¸º xz-utils
        zstd \
        lz4 \
        upx-ucl \           # åŒ…åä» upx æ”¹ä¸º upx-ucl
        cpio \
        gzip \
        file \
        findutils \
        coreutils \
        jq \                # ç”¨äºJSONè§£æ
        && rm -rf /var/lib/apt/lists/*

        # å®‰è£…mkisofsï¼ˆå¦‚æœéœ€è¦ï¼‰
        RUN if ! command -v mkisofs >/dev/null 2>&1; then \
        apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y mkisofs; \
        fi

        WORKDIR /builder

        # å¤åˆ¶æ„å»ºè„šæœ¬
        COPY build-tinycore.sh /builder/build-tinycore.sh
        RUN chmod +x /builder/build-tinycore.sh

        # åˆ›å»ºæŒ‚è½½ç‚¹ç›®å½•
        RUN mkdir -p /mnt /output

        ENTRYPOINT ["/builder/build-tinycore.sh"]
        DOCKEREOF
        echo "âœ… Dockerfileåˆ›å»ºå®Œæˆ"
    - name: ä¸‹è½½OpenWRTé•œåƒ
      id: download
      run: |
        echo "ä¸‹è½½OpenWRTé•œåƒ..."
        
        # åˆ›å»ºä¸‹è½½ç›®å½•
        mkdir -p downloads
        cd downloads
        echo "å½“å‰ç›®å½•: $(pwd)"
        
        OPENWRT_URL="${{ github.event.inputs.openwrt_image_url }}"
        OUTPUT_IMG="openwrt.img"
        # æ–¹æ³•1: å°è¯•ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
        REPO="sirpdboy/openwrt"
        echo "è·å–æœ€æ–°ç‰ˆæœ¬..."
        # è·å–æœ€æ–°ç‰ˆæœ¬
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        if [ -z "$LATEST_RELEASE" ]; then
            echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ç¡¬ç¼–ç ç‰ˆæœ¬"
            LATEST_RELEASE="v2026.01.01"
        fi
        echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_RELEASE"
        # è·å–ä¸‹è½½URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "æ— æ³•è·å–ä¸‹è½½URLï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            # å¤‡ç”¨URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        OPENWRT_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        
        # å°è¯•ä¸‹è½½
        if wget -q -O "$OUTPUT_IMG.gz" "$OPENWRT_URL"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ: $(du -h "$OUTPUT_IMG.gz" | cut -f1)"
            
            # å°è¯•è§£å‹
            if gzip -t "$OUTPUT_IMG.gz" 2>/dev/null; then
                echo "æ£€æµ‹åˆ°gzipå‹ç¼©æ ¼å¼ï¼Œæ­£åœ¨è§£å‹..."
                gzip -d "$OUTPUT_IMG.gz"
                echo "è§£å‹æˆåŠŸ"
            else
                echo "ä¸æ˜¯gzipæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨"
                mv "$OUTPUT_IMG.gz" "$OUTPUT_IMG"
            fi
            
            if [ -f "$OUTPUT_IMG" ]; then
                IMG_ABS_PATH="$(pwd)/$OUTPUT_IMG"
                echo "é•œåƒä½ç½®: $IMG_ABS_PATH"
                echo "é•œåƒå¤§å°: $(du -h "$IMG_ABS_PATH" | cut -f1)"
                echo "img_path=$IMG_ABS_PATH" >> $GITHUB_OUTPUT
            else
                echo "âŒ é•œåƒæ–‡ä»¶ä¸å­˜åœ¨"
                exit 1
            fi
        else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            # åˆ›å»ºæµ‹è¯•æ–‡ä»¶
            dd if=/dev/zero of="$OUTPUT_IMG" bs=1M count=10
            IMG_ABS_PATH="$(pwd)/$OUTPUT_IMG"
            echo "åˆ›å»ºæµ‹è¯•æ–‡ä»¶: $IMG_ABS_PATH"
            echo "img_path=$IMG_ABS_PATH" >> $GITHUB_OUTPUT
        fi
        
    - name: åˆ›å»ºè¾“å‡ºç›®å½•
      run: |
        mkdir -p output
        chmod 777 output
        echo "âœ… è¾“å‡ºç›®å½•å‡†å¤‡å®Œæˆ"
        
        

    - name: æ„å»ºDockeré•œåƒ
      run: |
        echo "ğŸ³ æ„å»ºDockeré•œåƒ..."
    
        # å…ˆå®‰è£…å¿…è¦ä¾èµ–ï¼ˆå¦‚æœåœ¨GitHub Actionsä¸­ï¼‰
        sudo apt-get update && sudo apt-get install -y docker.io
    
        # æ„å»ºé•œåƒ
        docker build -t openwrt-iso-builder -f Dockerfile.openwrt-builder .
    
        if [ $? -eq 0 ]; then
        echo "âœ… Dockeré•œåƒæ„å»ºæˆåŠŸ"
        # éªŒè¯é•œåƒ
        docker image ls | grep openwrt-iso-builder
        else
        echo "âŒ Dockeré•œåƒæ„å»ºå¤±è´¥"
        exit 1
        fi

    - name: è¿è¡ŒISOæ„å»º
      run: |
        echo "ğŸ”¨ è¿è¡ŒISOæ„å»º..."
    
        # æ£€æŸ¥è¾“å…¥æ–‡ä»¶
        if [ ! -f "assets/ezopwrt.img" ]; then
        echo "âŒ æ‰¾ä¸åˆ°OpenWRTé•œåƒæ–‡ä»¶"
        ls -la assets/ || echo "assetsç›®å½•ä¸å­˜åœ¨"
        exit 1
        fi
    
        # ç¡®ä¿è„šæœ¬å­˜åœ¨ä¸”æœ‰æ‰§è¡Œæƒé™
        if [ ! -f "build-tinycore.sh" ]; then
        echo "âŒ æ‰¾ä¸åˆ°æ„å»ºè„šæœ¬"
        exit 1
        fi
        chmod +x build-tinycore.sh
    
        echo "è¾“å…¥æ–‡ä»¶:"
        echo "  OpenWRTé•œåƒ: assets/ezopwrt.img ($(du -h assets/ezopwrt.img | cut -f1))"
        echo "  æ„å»ºè„šæœ¬: build-tinycore.sh"
        echo "  è¾“å‡ºç›®å½•: output/"
    
        # ä½¿ç”¨Dockerè¿è¡Œæ„å»º
        docker run --rm \
        --name openwrt-builder \
        -v "$(pwd)/assets/ezopwrt.img:/mnt/openwrt.img:ro" \
        -v "$(pwd)/build-tinycore.sh:/builder/build-tinycore.sh:ro" \
        -v "$(pwd)/output:/builder/output" \
        openwrt-iso-builder \
        "/mnt/openwrt.img" \
        "/builder/output" \
        "openwrt-installer.iso"
    
        # æ£€æŸ¥æ„å»ºç»“æœ
        if [ $? -eq 0 ]; then
        echo "âœ… ISOæ„å»ºå®Œæˆ"
        else
        echo "âŒ ISOæ„å»ºå¤±è´¥"
        exit 1
        fi

    - name: éªŒè¯ISOæ–‡ä»¶
      run: |
        if ls output/*.iso 1>/dev/null 2>&1; then
            ISO_FILE=$(ls output/*.iso)
            echo "âœ… ISOæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $(basename $ISO_FILE)"
            echo "æ–‡ä»¶å¤§å°: $(du -h "$ISO_FILE" | cut -f1)"
            
            # åŸºæœ¬éªŒè¯
            echo ""
            echo "ISOæ–‡ä»¶éªŒè¯:"
            file "$ISO_FILE"
            
            # æ£€æŸ¥æ˜¯å¦æ”¯æŒBIOS/UEFI
            if command -v xorriso >/dev/null 2>&1; then
                echo ""
                echo "å¼•å¯¼ä¿¡æ¯:"
                xorriso -indev "$ISO_FILE" -toc 2>/dev/null | grep -E "(Bootable|El-Torito|UEFI)" || true
            fi
        else
            echo "âŒ æ²¡æœ‰ç”ŸæˆISOæ–‡ä»¶"
            exit 1
        fi

    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-iso
        path: output/*.iso
        retention-days: 7
  
