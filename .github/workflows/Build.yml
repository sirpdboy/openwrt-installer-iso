name: Build

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      openwrt_image_url:
        description: 'OpenWRT镜像URL（可选）'
        required: false

env:
  ISO_NAME: "openwrt-installer"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Docker (Fixed)
      run: |
        # 清理已有Docker安装
        sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
        sudo apt-get autoremove -y
        
        # 安装必要依赖
        sudo apt-get update
        sudo apt-get install -y \
            ca-certificates \
            curl \
            gnupg \
            lsb-release
        
        # 添加Docker官方GPG密钥
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        
        # 设置仓库
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # 安装Docker
        sudo apt-get update
        sudo apt-get install -y \
            docker-ce \
            docker-ce-cli \
            containerd.io \
            docker-compose-plugin
        
        # 启动服务
        sudo systemctl start docker
        sudo systemctl enable docker
        
        # 验证
        docker --version
        echo "✅ Docker安装成功"
    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # 如果有自定义URL，使用它
        if [[ -n "${{ github.event.inputs.openwrt_image_url }}" ]]; then
          echo "使用自定义镜像URL"
          wget -q "${{ github.event.inputs.openwrt_image_url }}" -O assets/ezopwrt.img.gz
        else
        if [ -f scripts/download-image.sh ]; then
          chmod +x scripts/download-image.sh
          ./scripts/download-image.sh
        else
          echo "下载OpenWRT镜像..."
          REPO="sirpdboy/openwrt"
          TAG=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
          DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
                jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url')
          FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
          echo "下载: $FIRST_URL"
          wget -q $FIRST_URL  -O assets/ezopwrt.img.gz
           if [ ! -f "assets/ezopwrt.img.gz" ]; then
             curl -L -o "$OUTPUT_FILE"  --progress-bar --retry 3 "$FIRST_URL" 
           fi
        
           if [ $? -eq 0 ]; then
               echo "✅ 下载完成"
            fi

        fi
        fi
          if [ -f "assets/ezopwrt.img.gz" ]; then
            gzip -d assets/ezopwrt.img.gz
            echo "✅ 镜像下载成功"
          else
            echo "⚠️  镜像下载失败，创建测试文件"
            dd if=/dev/zero of=assets/ezopwrt.img bs=1M count=50
            mkfs.ext4 assets/ezopwrt.img >/dev/null 2>&1
          fi
        
          
        if [ -f "assets/ezopwrt.img" ]; then
          echo "镜像大小: $(stat -c%s assets/ezopwrt.img | numfmt --to=iec)"
          ls -lh assets/ezopwrt.img
        else
          echo "❌ 镜像准备失败"
          exit 1
        fi

    - name: Prepare build script
      run: |
        # 确保构建脚本有权限
        chmod +x build-iso.sh
        echo "构建脚本准备完成"
        head -5 build-iso.sh

    - name: Create output directory
      run: |
        mkdir -p output
        chmod 777 output

    - name: Build ISO with Docker
      run: |
        # 使用Docker构建ISO

        chmod +x build.sh
        docker run --privileged --rm \
          -v $(pwd)/output:/output \
          -v $(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro \
          -v $(pwd)/build.sh:/build.sh:ro \
          debian:buster \
          bash -c "
          set -e
          echo '=== 安装必要工具 ==='
          
          # 配置源
          echo 'deb http://archive.debian.org/debian buster main contrib non-free' > /etc/apt/sources.list
          echo 'deb http://archive.debian.org/debian-security buster/updates main' >> /etc/apt/sources.list
          echo 'Acquire::Check-Valid-Until \"false\";' > /etc/apt/apt.conf.d/99no-check-valid-until
          
          # 安装工具
          apt-get update
          apt-get install -y \
            xorriso \
            isolinux \
            syslinux-efi \
            wget \
            curl \
            gzip \
            file
          
          echo '=== 执行构建脚本 ==='
          # chmod +x /build.sh
          /build.sh
          
          echo '=== 构建完成 ==='
          "

    - name: Verify ISO
      run: |
        ISO_FILE="output/${ISO_NAME}.iso"
        if [ -f "$ISO_FILE" ]; then
          echo "✅ ISO构建成功!"
          echo "文件: $ISO_FILE"
          echo "大小: $(ls -lh "$ISO_FILE" | awk '{print $5}')"
          echo "MD5: $(md5sum "$ISO_FILE" | cut -d' ' -f1)"
          
          # 验证ISO结构
          echo "ISO引导信息:"
          if command -v xorriso >/dev/null 2>&1; then
            xorriso -indev "$ISO_FILE" -toc 2>&1 | grep -E "(El-Torito|bootable)" || true
          fi
        else
          echo "❌ ISO构建失败"
          echo "output目录内容:"
          ls -la output/
          exit 1
        fi

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-iso
        path: output/${ISO_NAME}.iso
        retention-days: 30
        if-no-files-found: error

    - name: Create GitHub Release (tag触发)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: output/${ISO_NAME}.iso
        body: |
          # OpenWRT 安装器 ISO
          
          ## 构建信息
          - **版本**: ${{ github.ref_name }}
          - **时间**: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          - **提交**: ${{ github.sha }}
          - **大小**: $(stat -c%s "output/${ISO_NAME}.iso" | numfmt --to=iec)
          
          ## 特性
          - ✅ 使用预编译内核（100%可引导）
          - ✅ 交互式安装界面
          - ✅ 支持BIOS引导
          - ✅ 自动磁盘检测
          
          ## 使用说明
          1. **下载ISO文件**
          2. **写入USB设备**:
             ```bash
             sudo dd if=${ISO_NAME}.iso of=/dev/sdX bs=4M status=progress
             sync
             ```
          3. **从USB启动计算机**
          4. **选择 "Install OpenWRT"**
          5. **按照屏幕提示安装**
          
          ## 注意事项
          - 安装会完全擦除目标磁盘
          - 确保选择正确的磁盘设备
          - 建议先在虚拟机中测试
        draft: false
        prerelease: false
