name: Build ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker (Fixed)
      run: |
        # 清理已有Docker安装
        sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
        sudo apt-get autoremove -y
        
        # 安装必要依赖
        sudo apt-get update
        sudo apt-get install -y \
            ca-certificates \
            curl \
            gnupg \
            lsb-release
        
        # 添加Docker官方GPG密钥
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        
        # 设置仓库
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # 安装Docker
        sudo apt-get update
        sudo apt-get install -y \
            docker-ce \
            docker-ce-cli \
            containerd.io \
            docker-compose-plugin
        
        # 启动服务
        sudo systemctl start docker
        sudo systemctl enable docker
        
        # 验证
        docker --version
        echo "✅ Docker安装成功"

    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # 使用你的下载脚本或直接下载
        if [ -f scripts/download-image.sh ]; then
          chmod +x scripts/download-image.sh
          ./scripts/download-image.sh
        else
          echo "下载OpenWRT镜像..."
          REPO="sirpdboy/openwrt"
          TAG=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
          DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
                jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url')
          FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
          echo "下载: $FIRST_URL"
          wget -q $FIRST_URL  -O assets/ezopwrt.img.gz
           if [ ! -f "assets/ezopwrt.img.gz" ]; then
             curl -L -o "$OUTPUT_FILE"  --progress-bar --retry 3 "$FIRST_URL" 
           fi
        
           if [ $? -eq 0 ]; then
               echo "✅ 下载完成"
               gzip -d assets/ezopwrt.img.gz
            fi
            
        fi
        echo "✅ 镜像大小: $(stat -c%s assets/ezopwrt.img | numfmt --to=iec)"

    - name: Create output directory
      run: |
        mkdir -p output
        chmod 777 output
    - name: Build ISO with working kernel
      run: | 
        cat > build-iso-fixed.sh << 'FIXED_EOF'
        #!/bin/bash
        set -e
        echo "使用预编译内核构建ISO..."

        wget -q "http://ftp.debian.org/debian/dists/buster/main/installer-amd64/current/images/cdrom/vmlinuz" \
            -O /tmp/vmlinuz-debian
        wget -q "http://ftp.debian.org/debian/dists/buster/main/installer-amd64/current/images/cdrom/initrd.gz" \
            -O /tmp/initrd.gz

        ISO_DIR="/tmp/iso-simple"
        mkdir -p "$ISO_DIR"/{isolinux,live}

        # 复制内核和initrd
        cp /tmp/vmlinuz-debian "$ISO_DIR/live/vmlinuz"
        gzip -dc /tmp/initrd.gz > "$ISO_DIR/live/initrd"

        # 复制OpenWRT镜像
        cp "/mnt/ezopwrt.img" "$ISO_DIR/live/openwrt.img"

        # 引导配置
        cat > "$ISO_DIR/isolinux/isolinux.cfg" << 'CFG'
        DEFAULT linux
        TIMEOUT 100
        LABEL linux
          MENU LABEL Install OpenWRT
          KERNEL /live/vmlinuz
          APPEND initrd=/live/initrd boot=live
        CFG

        # 复制引导文件
        cp /usr/lib/ISOLINUX/isolinux.bin "$ISO_DIR/isolinux/"

        # 创建ISO
        xorriso -as mkisofs \
            -o "/output/openwrt-installer.iso" \
            -b isolinux/isolinux.bin \
            -no-emul-boot \
            -boot-load-size 4 \
            "$ISO_DIR"

        echo "✅ ISO创建完成"
        ls -lh "/output/openwrt-installer.iso"
        FIXED_EOF

        chmod +x build-iso-fixed.sh
    
        # 执行构建
            docker run --privileged --rm \
              -v $(pwd)/output:/output \
              -v $(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro \
              -v $(pwd)/build-iso-fixed.sh:/build.sh \
              debian:buster \
              bash -c "
              apt-get update
              apt-get install -y xorriso isolinux wget
              /build.sh
              "

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: ezopwrt-installer
        path: output/*.iso
        retention-days: 30

    - name: Create GitHub Release (tag触发)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: output/*.iso
        body: |
          # EzOpWrt 安装器
          
          ## 构建信息
          - 版本: ${{ github.ref_name }}
          - 时间: $(date)
          - 提交: ${{ github.sha }}
          
          ## 使用说明
          1. 下载ISO文件
          2. 写入USB: `sudo dd if=ezopwrt-installer.iso of=/dev/sdX bs=4M status=progress`
          3. 从USB启动
          4. 按照屏幕提示安装
