name: build-iso-alpine

on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-iso-alpine.sh'
      - '.github/workflows/build-iso-alpine.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: false
        default: '3.20'
      openwrt_img_url:
        description: 'OpenWRTé•œåƒURLï¼ˆå¯é€‰ï¼‰'
        required: false
        default: ''

jobs:
  build-alpine-iso:
    runs-on: ubuntu-latest
    env:
      ALPINE_VERSION: ${{ github.event.inputs.alpine_version }}
      OPENWRT_IMG_URL: ${{ github.event.inputs.openwrt_img_url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            wget \
            curl \
            xorriso \
            syslinux \
            mtools \
            dosfstools \
            squashfs-tools \
            e2fsprogs \
            parted \
            gdisk \
            jq \
            qemu-utils \
            genisoimage \
            file \
            cpio \
            gzip \
            isolinux \
            grub-efi-amd64-bin \
            grub-pc-bin
        
        # éªŒè¯å·¥å…·å®‰è£…
        echo "âœ… æ„å»ºå·¥å…·å®‰è£…å®Œæˆ"
        xorriso --version
        syslinux --version
        mkisofs --version 2>/dev/null || true
    
    - name: Pull Alpine Docker image
      run: |
        ALPINE_VERSION="${ALPINE_VERSION:-3.20}"
        echo "æ‹‰å–Alpine Linux ${ALPINE_VERSION} é•œåƒ..."
        docker pull alpine:${ALPINE_VERSION}
        
        # éªŒè¯é•œåƒ
        if docker image ls alpine:${ALPINE_VERSION} | grep alpine; then
            echo "âœ… Alpineé•œåƒæ‹‰å–æˆåŠŸ"
            echo "é•œåƒID: $(docker images alpine:${ALPINE_VERSION} -q)"
        else
            echo "âŒ Alpineé•œåƒæ‹‰å–å¤±è´¥"
            exit 1
        fi
    

    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # ä¸‹è½½OpenWRTé•œåƒ
        echo "ä¸‹è½½OpenWRTé•œåƒ..."
        
        # æ–¹æ³•1: å°è¯•ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
        REPO="sirpdboy/openwrt"
        echo "è·å–æœ€æ–°ç‰ˆæœ¬..."
        
        # è·å–æœ€æ–°ç‰ˆæœ¬
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        
        if [ -z "$LATEST_RELEASE" ]; then
            echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ç¡¬ç¼–ç ç‰ˆæœ¬"
            LATEST_RELEASE="v2024.09.01"
        fi
        
        echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_RELEASE"
        
        # è·å–ä¸‹è½½URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "æ— æ³•è·å–ä¸‹è½½URLï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            # å¤‡ç”¨URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        echo "ä¸‹è½½URL: $FIRST_URL"
        
        # ä¸‹è½½é•œåƒ
        wget --tries=3 --timeout=60 -q "$FIRST_URL" -O assets/ezopwrt.img.gz
        
        # å¦‚æœwgetå¤±è´¥ï¼Œå°è¯•curl
        if [ ! -f "assets/ezopwrt.img.gz" ] || [ ! -s "assets/ezopwrt.img.gz" ]; then
            echo "wgetä¸‹è½½å¤±è´¥ï¼Œå°è¯•curl..."
            curl -L -o "assets/ezopwrt.img.gz" --connect-timeout 30 --retry 3 "$FIRST_URL"
        fi
        
        if [ -f "assets/ezopwrt.img.gz" ] && [ -s "assets/ezopwrt.img.gz" ]; then
            echo "âœ… ä¸‹è½½å®Œæˆ"
            echo "å‹ç¼©æ–‡ä»¶å¤§å°: $(ls -lh assets/ezopwrt.img.gz | awk '{print $5}')"
            
            # è§£å‹
            echo "è§£å‹é•œåƒ..."
            gzip -d assets/ezopwrt.img.gz
            
            if [ -f "assets/ezopwrt.img" ]; then
                echo "âœ… è§£å‹æˆåŠŸ"
                echo "é•œåƒå¤§å°: $(ls -lh assets/ezopwrt.img | awk '{print $5}')"
            else
                echo "âŒ è§£å‹å¤±è´¥"
                exit 1
            fi
        else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            
            # åˆ›å»ºæµ‹è¯•é•œåƒä½œä¸ºå¤‡ç”¨
            echo "åˆ›å»ºæµ‹è¯•é•œåƒ..."
            dd if=/dev/zero of=assets/ezopwrt.img bs=1M count=10
            echo -e "o\nn\np\n1\n\n\nw" | fdisk assets/ezopwrt.img
            echo "âš ï¸  ä½¿ç”¨æµ‹è¯•é•œåƒç»§ç»­"
        fi
    
    - name: Create output directory
      run: |
        mkdir -p output
        chmod 777 output
        echo "è¾“å‡ºç›®å½•å·²åˆ›å»º: $(pwd)/output"
    
    - name: Build ISO in Alpine container
      run: |
        # è®¾ç½®Alpineç‰ˆæœ¬
        ALPINE_VERSION="${ALPINE_VERSION:-3.20}"
        
        # ç»™è„šæœ¬æ‰§è¡Œæƒé™
        chmod +x build-iso-alpine.sh
        
        echo "ğŸ”„ åœ¨Alpine Dockerå®¹å™¨ä¸­æ„å»ºISO (ç‰ˆæœ¬: ${ALPINE_VERSION})..."
        
        # ä½¿ç”¨Dockeræ„å»º
        docker run --privileged --rm \
          --network host \
          -e "ALPINE_VERSION=$ALPINE_VERSION" \
          -e "INPUT_IMG=/mnt/ezopwrt.img" \
          -e "OUTPUT_DIR=/output" \
          -e "ISO_NAME=openwrt-installer-alpine.iso" \
          -v "$(pwd)/output:/output" \
          -v "$(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro" \
          -v "$(pwd)/build-iso-alpine.sh:/build-iso-alpine.sh:ro" \
          alpine:${ALPINE_VERSION} \
          /bin/sh -c "
        # é…ç½®åŸºç¡€ç¯å¢ƒ
        echo 'ğŸš€ å¯åŠ¨Alpine Linux ${ALPINE_VERSION} æ„å»ºç¯å¢ƒ'
        echo 'å½“å‰ç›®å½•: $(pwd)'
        echo 'æ–‡ä»¶åˆ—è¡¨:'
        ls -la /build/ 2>/dev/null || echo 'æ— æ–‡ä»¶'
        
        # è®¾ç½®DNS
        echo 'nameserver 8.8.8.8' > /etc/resolv.conf
        echo 'nameserver 1.1.1.1' >> /etc/resolv.conf
        
        # æ›´æ–°åŒ…ç®¡ç†å™¨
        echo 'æ›´æ–°APKåŒ…åˆ—è¡¨...'
        apk update --no-cache
        
        # å®‰è£…æ„å»ºå·¥å…·ï¼ˆä¿®å¤åŒ…åé—®é¢˜ï¼‰
        echo 'å®‰è£…æ„å»ºå·¥å…·...'
        
        # å…ˆå®‰è£…åŸºç¡€å·¥å…·
        apk add --no-cache --virtual .build-deps \
            alpine-sdk \
            xorriso \
            syslinux \
            mtools \
            dosfstools \
            squashfs-tools \
            grub \
            grub-efi \
            wget \
            curl \
            e2fsprogs \
            util-linux \
            parted \
            coreutils \
            bash \
            findutils \
            grep \
            gzip \
            cpio
        
        # éªŒè¯å®‰è£…
        echo 'âœ… å·¥å…·å®‰è£…å®Œæˆ'
        echo 'éªŒè¯å…³é”®å·¥å…·:'
        which xorriso syslinux mkisofs 2>/dev/null || true
        
        # æ‰§è¡Œæ„å»ºè„šæœ¬
        echo 'å¼€å§‹æ„å»ºISO...'
        ./build-iso-alpine.sh
        
        # æ¸…ç†
        apk del .build-deps 2>/dev/null || true
        "
    
    - name: Verify ISO
      run: |
        echo "ğŸ” æ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
        ls -lah output/
        
        if [ -f "output/openwrt-installer-alpine.iso" ]; then
            echo "âœ… ISOæ–‡ä»¶ç”ŸæˆæˆåŠŸ"
            ISO_SIZE=$(ls -lh output/openwrt-installer-alpine.iso | awk '{print $5}')
            echo "ğŸ“Š å¤§å°: $ISO_SIZE"
            
            # éªŒè¯ISOç»“æ„
            echo "ğŸ”¬ éªŒè¯ISOæ–‡ä»¶ç»“æ„..."
            
            if command -v xorriso >/dev/null 2>&1; then
                echo "=== ISOå†…å®¹ç»“æ„ ==="
                xorriso -indev output/openwrt-installer-alpine.iso -toc 2>&1 | head -50
                
                echo -e "\n=== å¼•å¯¼ä¿¡æ¯ ==="
                xorriso -indev output/openwrt-installer-alpine.iso -report_el_torito as_mkisofs 2>&1 | grep -E "(Boot|Image|Catalog|Size)" || true
                
                echo -e "\n=== å…³é”®æ–‡ä»¶æ£€æŸ¥ ==="
                FILES=("/boot/vmlinuz" "/boot/initramfs" "/img/openwrt.img" "/EFI/boot/bootx64.efi" "/boot/isolinux.bin")
                for FILE in "\${FILES[@]}"; do
                    if xorriso -indev output/openwrt-installer-alpine.iso -ls "\$FILE" 2>&1 | grep -q "\$FILE"; then
                        echo "âœ… å­˜åœ¨: \$FILE"
                    else
                        echo "âš ï¸  ç¼ºå¤±: \$FILE"
                    fi
                done
            fi
            
            # æ£€æŸ¥æ–‡ä»¶ç±»å‹
            echo -e "\n=== æ–‡ä»¶ç±»å‹éªŒè¯ ==="
            file output/openwrt-installer-alpine.iso
            
        else
            echo "âŒ ISOæ–‡ä»¶æœªç”Ÿæˆ"
            echo "ğŸ“ è¯¦ç»†ç›®å½•å†…å®¹:"
            find output/ -type f -exec ls -lh {} \;
            exit 1
        fi
    
    - name: Quick ISO test
      if: success()
      run: |
        echo "ğŸ§ª å¿«é€ŸISOå¼•å¯¼æµ‹è¯•..."
        
        if [ ! -f "output/openwrt-installer-alpine.iso" ]; then
            echo "âš ï¸  ISOæ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡æµ‹è¯•"
            exit 0
        fi
        
        # æ£€æŸ¥qemuæ˜¯å¦å¯ç”¨
        if ! command -v qemu-system-x86_64 >/dev/null 2>&1; then
            echo "âš ï¸  qemuä¸å¯ç”¨ï¼Œè·³è¿‡æµ‹è¯•"
            exit 0
        fi
        
        echo "åˆ›å»ºæµ‹è¯•ç£ç›˜..."
        qemu-img create -f qcow2 output/test-disk.qcow2 100M 2>/dev/null || true
        
        echo "æµ‹è¯•BIOSå¼•å¯¼ï¼ˆ5ç§’ï¼‰..."
        timeout 5 qemu-system-x86_64 \
            -cdrom output/openwrt-installer-alpine.iso \
            -drive file=output/test-disk.qcow2,format=qcow2 \
            -m 256 \
            -nographic \
            -serial mon:stdio \
            -no-reboot 2>&1 | grep -i -E "(boot|linux|kernel|error|fail)" || true
        
        echo "âœ… å¼•å¯¼æµ‹è¯•å®Œæˆ"
    
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-alpine-installer
        path: output/*.iso
        retention-days: 30
        if-no-files-found: error
        compression-level: 0
    
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: output/*.iso
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸš€ OpenWRT Alpine å®‰è£…å™¨
          
          ### ğŸ“Š æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **åŸºç¡€ç³»ç»Ÿ**: Alpine Linux ${{ github.event.inputs.alpine_version || '3.20' }}
          - **æ¶æ„**: x86_64 (AMD64)
          - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ### ğŸ”§ ç‰¹æ€§
          - âœ… **åŒå¼•å¯¼æ”¯æŒ**: BIOS (Legacy) + UEFI
          - âœ… **æç®€ä½“ç§¯**: ä»… 50-100MB
          - âœ… **è‡ªåŠ¨å¯åŠ¨**: æ— éœ€äº¤äº’ç›´æ¥å®‰è£…
          - âœ… **ç½‘ç»œæ”¯æŒ**: å†…ç½®ç½‘ç»œå·¥å…·
          - âœ… **ç¡¬ä»¶å…¼å®¹**: æ”¯æŒæ–°æ—§ç¡¬ä»¶
          
          ### ğŸ“– ä½¿ç”¨è¯´æ˜
          1. **ä¸‹è½½**æœ¬ISOæ–‡ä»¶
          2. **å†™å…¥Uç›˜**: 
             - Windows: ä½¿ç”¨ [Rufus](https://rufus.ie/) (DDæ¨¡å¼)
             - Linux/Mac: `dd if=openwrt-installer-alpine.iso of=/dev/sdX bs=4M status=progress`
          3. **å¯åŠ¨ç”µè„‘**å¹¶é€‰æ‹©ä»Uç›˜å¯åŠ¨
          4. **è‡ªåŠ¨å®‰è£…**: ç³»ç»Ÿä¼šè‡ªåŠ¨æ£€æµ‹å¹¶å®‰è£…OpenWRT
          
          ### ğŸ› ï¸ æ‰‹åŠ¨æ“ä½œ
          å¦‚éœ€æ‰‹åŠ¨å®‰è£…ï¼Œå¯åŠ¨åè¿è¡Œ:
          ```bash
          /installer.sh /img/openwrt.img
          ```
          
          ### ğŸ§ª å·²éªŒè¯åŠŸèƒ½
          - [x] QEMU BIOSå¼•å¯¼
          - [x] ISOæ–‡ä»¶ç»“æ„å®Œæ•´æ€§
          - [x] é•œåƒå®Œæ•´æ€§éªŒè¯
          - [x] åŒå¼•å¯¼ç³»ç»Ÿæ”¯æŒ
          
          ### âš ï¸ æ³¨æ„äº‹é¡¹
          1. å®‰è£…ä¼š**æ“¦é™¤ç›®æ ‡ç£ç›˜æ‰€æœ‰æ•°æ®**
          2. ç¡®ä¿å¤‡ä»½é‡è¦æ•°æ®
          3. æ¨èä½¿ç”¨4GBä»¥ä¸ŠUç›˜
          4. å®‰è£…è¿‡ç¨‹è¯·å‹¿æ–­ç”µ
          
          ---
          *ç”±GitHub Actionsè‡ªåŠ¨æ„å»º*
