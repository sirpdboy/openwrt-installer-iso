name: build-iso-alpine

on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-iso-alpine.sh'
      - '.github/workflows/build-iso-alpine.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: false
        default: '3.20'

jobs:
  build-alpine-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            wget \
            curl \
            xorriso \
            syslinux \
            mtools \
            dosfstools \
            squashfs-tools \
            e2fsprogs \
            parted \
            gdisk \
            jq
    
    - name: Setup Docker
      run: |
        # å®‰è£…Docker
        curl -fsSL https://get.docker.com -o get-docker.sh
        sudo sh get-docker.sh
        sudo usermod -aG docker $USER
        sudo systemctl start docker
        sudo systemctl enable docker
        docker --version
    
    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # ä¸‹è½½OpenWRTé•œåƒ
        echo "ä¸‹è½½OpenWRTé•œåƒ..."
        REPO="sirpdboy/openwrt"
        TAG=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        
        if [ -z "$TAG" ]; then
          echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨é»˜è®¤URL"
          # ä½¿ç”¨ä¸€ä¸ªå·²çŸ¥çš„URLä½œä¸ºå¤‡é€‰
          wget -O assets/ezopwrt.img.gz "https://github.com/sirpdboy/openwrt/releases/download/v2024.12.02/ezopenwrt-x86-64-generic-squashfs-combined.img.gz" || true
        else
          echo "æ‰¾åˆ°ç‰ˆæœ¬: $TAG"
          DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
                jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url')
          FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
          echo "ä¸‹è½½: $FIRST_URL"
          wget -q $FIRST_URL -O assets/ezopwrt.img.gz
        fi
        
        if [ -f "assets/ezopwrt.img.gz" ]; then
          echo "âœ… ä¸‹è½½å®Œæˆ"
          gzip -d assets/ezopwrt.img.gz
          echo "âœ… é•œåƒå¤§å°: $(stat -c%s assets/ezopwrt.img | numfmt --to=iec)"
        else
          echo "âŒ ä¸‹è½½å¤±è´¥"
          # åˆ›å»ºä¸€ä¸ªå°çš„æµ‹è¯•é•œåƒ
          echo "åˆ›å»ºæµ‹è¯•é•œåƒ..."
          dd if=/dev/zero of=assets/ezopwrt.img bs=1M count=10
          echo "æµ‹è¯•é•œåƒåˆ›å»ºå®Œæˆ"
        fi
    
    - name: Build ISO with Alpine
      run: |
        mkdir -p output
        chmod 777 output
            chmod +x build-iso-alpine.sh
    
        
        echo "ğŸ³ åœ¨Dockerå®¹å™¨ä¸­æ„å»ºISO..."
            # 2. å¤åˆ¶è„šæœ¬åˆ°å®¹å™¨å†…æ‰§è¡Œ
            docker run --privileged --rm \
              -v $(pwd)/output:/output \
              -v $(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro \
              -v $(pwd)/build-iso-alpine.sh:/build-iso-alpine.sh:ro \
              debian:buster \
              bash -c "
              # å®‰è£…å¿…è¦å·¥å…·
              apt-get update
              apt-get install -y \
                debootstrap squashfs-tools xorriso isolinux syslinux-efi \
                grub-pc-bin grub-efi-amd64-bin mtools dosfstools parted wget curl
       
              /build-iso-alpine.sh
              "
    
    - name: Check ISO file
      run: |
        echo "ğŸ“ æ£€æŸ¥è¾“å‡ºæ–‡ä»¶:"
        ls -lh output/
        
        if [ -f "output/openwrt-autoinstall-alpine.iso" ]; then
            echo "âœ… ISOæ–‡ä»¶å­˜åœ¨"
            echo "å¤§å°: $(ls -lh output/openwrt-autoinstall-alpine.iso | awk '{print $5}')"
        else
            echo "âŒ ISOæ–‡ä»¶æœªç”Ÿæˆ"
            echo "å½“å‰ç›®å½•å†…å®¹:"
            find output/ -type f
            exit 1
        fi
    
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-alpine-installer
        path: output/*.iso
        retention-days: 30
        if-no-files-found: error
    
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: output/*.iso
        body: |
          # OpenWRT Alpine å®‰è£…å™¨
          
          ## ğŸš€ ç‰¹ç‚¹
          - ğŸ§ åŸºäº Alpine Linuxï¼Œæç®€è½»é‡
          - ğŸ“¦ ISOå¤§å°ä»… 50-80MB
          - ğŸš€ è‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€å¯†ç 
          - ğŸ”§ è‡ªåŠ¨ç™»å½• root ç”¨æˆ·
          - ğŸ’¾ æ”¯æŒ UEFI å’Œä¼ ç»Ÿ BIOS
          - âš¡ å¿«é€Ÿå¯åŠ¨ï¼Œä½å†…å­˜å ç”¨
          
          ## ğŸ“Š æ„å»ºä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          - æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S")
          - ç³»ç»Ÿ: Alpine Linux 3.20
          - æ¶æ„: x86_64
          - æäº¤: ${{ github.sha }}
          
          ## ğŸ¯ ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½ ISO æ–‡ä»¶
          2. ä½¿ç”¨ Rufusã€Etcher æˆ– dd å†™å…¥ U ç›˜
          3. ä» U ç›˜å¯åŠ¨è®¡ç®—æœº
          4. ç³»ç»Ÿä¼šè‡ªåŠ¨å¯åŠ¨ OpenWRT å®‰è£…ç¨‹åº
          5. æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
          
          ## ğŸ”§ æ‰‹åŠ¨æ“ä½œ
          å¦‚æœè‡ªåŠ¨å®‰è£…æœªå¯åŠ¨ï¼Œå¯ä»¥æ‰‹åŠ¨è¿è¡Œ:
          ```
          /opt/install-openwrt.sh
          ```
