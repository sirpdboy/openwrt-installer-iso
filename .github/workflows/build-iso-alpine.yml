name: build-ultra-minimal-iso

on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-iso-alpine.sh'
      - '.github/workflows/build-iso-alpine.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: false
        default: '3.20'
      compress_level:
        description: 'å‹ç¼©çº§åˆ« (1-9)'
        required: false
        default: '9'

jobs:
  build-ultra-minimal:
    runs-on: ubuntu-latest
    env:
      ALPINE_VERSION: ${{ github.event.inputs.alpine_version }}
      COMPRESS_LEVEL: ${{ github.event.inputs.compress_level }}
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: è®¾ç½®æ„å»ºç¯å¢ƒ
      run: |
        echo "ğŸ› ï¸ å®‰è£…æ„å»ºå·¥å…·..."
        sudo apt-get update
        sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xorriso \
            syslinux \
            isolinux \
            mtools \
            dosfstools \
            grub-efi-amd64-bin \
            grub-pc-bin \
            wget \
            curl \
            jq \
            file \
            cpio \
            gzip \
            xz-utils \
            zstd \
            lz4 \
            upx-ucl \
            pv \
            qemu-utils
        
        echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"
        echo "å·¥å…·ç‰ˆæœ¬:"
        xorriso --version | head -1
        syslinux --version | head -1
        upx --version | head -1
    
    - name: å‡†å¤‡Alpineå®¹å™¨
      run: |
        ALPINE_VERSION="${ALPINE_VERSION:-3.20}"
        echo "ğŸ³ æ‹‰å–Alpine Linux ${ALPINE_VERSION}..."
        docker pull alpine:${ALPINE_VERSION}
        
        # éªŒè¯
        docker image ls alpine:${ALPINE_VERSION} | grep alpine
        
    - name: è·å–OpenWRTé•œåƒ
     
      run: |
        mkdir -p assets
        
        # ä¸‹è½½OpenWRTé•œåƒ
        echo "ä¸‹è½½OpenWRTé•œåƒ..."
        
        # æ–¹æ³•1: å°è¯•ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
        REPO="sirpdboy/openwrt"
        echo "è·å–æœ€æ–°ç‰ˆæœ¬..."
        
        # è·å–æœ€æ–°ç‰ˆæœ¬
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        
        if [ -z "$LATEST_RELEASE" ]; then
            echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ç¡¬ç¼–ç ç‰ˆæœ¬"
            LATEST_RELEASE="v2024.09.01"
        fi
        
        echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_RELEASE"
        
        # è·å–ä¸‹è½½URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "æ— æ³•è·å–ä¸‹è½½URLï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            # å¤‡ç”¨URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        echo "ä¸‹è½½URL: $FIRST_URL"
        
        # ä¸‹è½½é•œåƒ
        wget --tries=3 --timeout=60 -q "$FIRST_URL" -O assets/ezopwrt.img.gz
        
        # å¦‚æœwgetå¤±è´¥ï¼Œå°è¯•curl
        if [ ! -f "assets/ezopwrt.img.gz" ] || [ ! -s "assets/ezopwrt.img.gz" ]; then
            echo "wgetä¸‹è½½å¤±è´¥ï¼Œå°è¯•curl..."
            curl -L -o "assets/ezopwrt.img.gz" --connect-timeout 30 --retry 3 "$FIRST_URL"
        fi
        
        if [ -f "assets/ezopwrt.img.gz" ] && [ -s "assets/ezopwrt.img.gz" ]; then
            echo "âœ… ä¸‹è½½å®Œæˆ"
            echo "å‹ç¼©æ–‡ä»¶å¤§å°: $(ls -lh assets/ezopwrt.img.gz | awk '{print $5}')"
            
            # è§£å‹
            echo "è§£å‹é•œåƒ..."
            gzip -d assets/ezopwrt.img.gz
            
            if [ -f "assets/ezopwrt.img" ]; then
                echo "âœ… è§£å‹æˆåŠŸ"
                echo "é•œåƒå¤§å°: $(ls -lh assets/ezopwrt.img | awk '{print $5}')"
            else
                echo "âŒ è§£å‹å¤±è´¥"
                exit 1
            fi
        else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            
            # åˆ›å»ºæµ‹è¯•é•œåƒä½œä¸ºå¤‡ç”¨
            echo "åˆ›å»ºæµ‹è¯•é•œåƒ..."
            dd if=/dev/zero of=assets/ezopwrt.img bs=1M count=10
            echo -e "o\nn\np\n1\n\n\nw" | fdisk assets/ezopwrt.img
            echo "âš ï¸  ä½¿ç”¨æµ‹è¯•é•œåƒç»§ç»­"
        fi
    
    - name: åˆ›å»ºè¾“å‡ºç›®å½•
      run: |
        mkdir -p output
        chmod 777 output
        echo "è¾“å‡ºç›®å½•: $(pwd)/output"
    
    - name: åœ¨Alpineä¸­æ„å»º
      run: |
        ALPINE_VERSION="${ALPINE_VERSION:-3.20}"
        COMPRESS_LEVEL="${COMPRESS_LEVEL:-9}"
        
        echo "ğŸ”¨ åœ¨Alpineå®¹å™¨ä¸­æ„å»ºæè‡´å‹ç¼©ISO..."
        echo "Alpineç‰ˆæœ¬: $ALPINE_VERSION"
        echo "å‹ç¼©çº§åˆ«: $COMPRESS_LEVEL"
        
        # ç»™è„šæœ¬æ‰§è¡Œæƒé™
        chmod +x build-iso-alpine.sh
        
        # è¿è¡Œæ„å»º
        docker run --privileged --rm \
          -e "ALPINE_VERSION=$ALPINE_VERSION" \
          -e "COMPRESS_LEVEL=$COMPRESS_LEVEL" \
          -e "INPUT_IMG=/mnt/openwrt.img" \
          -e "OUTPUT_DIR=/output" \
          -e "ISO_NAME=openwrt-ultra-minimal.iso" \
          -v "$(pwd)/output:/output" \
          -v "$(pwd)/assets/openwrt.img:/mnt/openwrt.img:ro" \
          -v "$(pwd)/build-iso-alpine.sh:/build-iso-alpine.sh:ro" \
          alpine:${ALPINE_VERSION} \
          /bin/sh -c "
        # Alpineå®¹å™¨å†…é…ç½®
        echo 'ğŸš€ è¿›å…¥Alpineæ„å»ºç¯å¢ƒ'
        
        # è®¾ç½®DNS
        echo 'nameserver 8.8.8.8' > /etc/resolv.conf
        echo 'nameserver 1.1.1.1' >> /etc/resolv.conf
        
        # å®‰è£…æè‡´å‹ç¼©æ‰€éœ€å·¥å…·
        echo 'ğŸ“¦ å®‰è£…å‹ç¼©å·¥å…·...'
        apk update --no-cache
        
        # å®‰è£…æ‰€æœ‰å‹ç¼©å·¥å…·
        apk add --no-cache --virtual .build-deps \
            alpine-sdk \
            xorriso \
            syslinux \
            syslinux-bios \
            mtools \
            dosfstools \
            grub \
            grub-efi \
            wget \
            curl \
            xz \
            zstd \
            lz4 \
            upx \
            cpio \
            gzip \
            file \
            findutils \
            coreutils \
            bash
        
        echo 'âœ… å·¥å…·å®‰è£…å®Œæˆ'
        
        # æ‰§è¡Œæ„å»ºè„šæœ¬
        echo 'ğŸ”¨ å¼€å§‹æ„å»º...'
        chmod +x /build-iso-alpine.sh
        /build-iso-alpine.sh
        
        # æ¸…ç†
        apk del .build-deps 2>/dev/null || true
        "
    
    - name: éªŒè¯ç»“æœ
      run: |
        echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
        
        if [ -f "output/openwrt-ultra-minimal.iso" ]; then
            ISO_SIZE=$(ls -lh output/openwrt-ultra-minimal.iso | awk '{print $5}')
            echo "âœ… ISOæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $ISO_SIZE"
            
            # è¯¦ç»†åˆ†æ
            echo "ğŸ“Š ISOæ–‡ä»¶åˆ†æ:"
            file output/openwrt-ultra-minimal.iso
            
            if command -v xorriso >/dev/null 2>&1; then
                echo "ğŸ“ ISOå†…å®¹:"
                xorriso -indev output/openwrt-ultra-minimal.iso -toc 2>&1 | head -20
                
                echo "ğŸ”§ å¼•å¯¼ä¿¡æ¯:"
                xorriso -indev output/openwrt-ultra-minimal.iso -report_el_torito as_mkisofs 2>&1 | \
                    grep -E "(Boot|Catalog|Sectors)" || true
            fi
            
            # è®¡ç®—å‹ç¼©æ•ˆæœ
            IMG_SIZE=$(ls -lh assets/openwrt.img | awk '{print $5}')
            echo "ğŸ“ˆ å‹ç¼©ç»Ÿè®¡:"
            echo "  - åŸå§‹é•œåƒ: $IMG_SIZE"
            echo "  - æœ€ç»ˆISO: $ISO_SIZE"
            
        else
            echo "âŒ ISOæ–‡ä»¶æœªç”Ÿæˆ"
            echo "å½“å‰æ–‡ä»¶:"
            ls -la output/
            exit 1
        fi
    
    - name: å¿«é€Ÿå¼•å¯¼æµ‹è¯•
      if: success()
      run: |
        echo "ğŸ§ª æ‰§è¡Œå¿«é€Ÿå¼•å¯¼æµ‹è¯•..."
        
        if [ ! -f "output/openwrt-ultra-minimal.iso" ]; then
            echo "âš ï¸  ISOæ–‡ä»¶ä¸å­˜åœ¨"
            exit 0
        fi
        
        if command -v qemu-system-x86_64 >/dev/null 2>&1; then
            echo "å¯åŠ¨QEMUæµ‹è¯• (5ç§’)..."
            
            # åˆ›å»ºæµ‹è¯•ç£ç›˜
            qemu-img create -f qcow2 output/test-disk.qcow2 1G 2>/dev/null || true
            
            # å¿«é€Ÿæµ‹è¯•
            timeout 5 qemu-system-x86_64 \
                -cdrom output/openwrt-ultra-minimal.iso \
                -drive file=output/test-disk.qcow2,format=qcow2 \
                -m 256 \
                -nographic \
                -no-reboot 2>&1 | \
                grep -i -E "(boot|starting|kernel|initramfs|error|fail)" || true
            
            echo "âœ… å¼•å¯¼æµ‹è¯•å®Œæˆ"
        else
            echo "âš ï¸  QEMUä¸å¯ç”¨ï¼Œè·³è¿‡æµ‹è¯•"
        fi
    
    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-ultra-minimal-installer
        path: |
          output/*.iso
          output/*.txt
        retention-days: 90
        if-no-files-found: error
    
    - name: åˆ›å»ºå‘å¸ƒ
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: output/*.iso
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          # ğŸš€ OpenWRT æè‡´å‹ç¼©å®‰è£…å™¨
          
          ## ğŸ“Š æ„å»ºä¿¡æ¯
          - **ç‰ˆæœ¬**: ${{ github.ref_name }}
          - **æ„å»ºæ—¶é—´**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          - **åŸºç¡€ç³»ç»Ÿ**: Alpine Linux ${{ github.event.inputs.alpine_version || '3.20' }}
          - **å‹ç¼©çº§åˆ«**: ${{ github.event.inputs.compress_level || '9' }}
          - **æ¶æ„**: x86_64
          - **æäº¤**: [${{ github.sha }}](https://github.com/${{ github.repository }}/commit/${{ github.sha }})
          
          ## ğŸ¯ æè‡´å‹ç¼©ç‰¹æ€§
          - âœ… **è¶…å°ä½“ç§¯**: ä»…éœ€æå°çš„ç³»ç»Ÿå¼€é”€
          - âœ… **æ™ºèƒ½å‹ç¼©**: è‡ªåŠ¨é€‰æ‹©æœ€ä½³å‹ç¼©ç®—æ³•
          - âœ… **åŒå¼•å¯¼**: BIOS (Legacy) + UEFI å®Œå…¨æ”¯æŒ
          - âœ… **å¿«é€Ÿå¯åŠ¨**: ä¼˜åŒ–çš„initramfså’Œå†…æ ¸
          - âœ… **è‡ªåŠ¨å®‰è£…**: æç®€ç”¨æˆ·äº¤äº’
          
          ## ğŸ“¦ æŠ€æœ¯äº®ç‚¹
          1. **UPXå‹ç¼©**: æ‰€æœ‰äºŒè¿›åˆ¶æ–‡ä»¶ä½¿ç”¨UPXæè‡´å‹ç¼©
          2. **å¤šç®—æ³•æµ‹è¯•**: è‡ªåŠ¨æµ‹è¯•gzip/xz/zstd/lz4ï¼Œé€‰æ‹©æœ€å°ç»“æœ
          3. **BusyBoxç²¾ç®€**: ä»…ä¿ç•™å¿…éœ€çš„8ä¸ªå‘½ä»¤
          4. **å†…æ ¸ä¼˜åŒ–**: ä½¿ç”¨æœ€å°å†…æ ¸æˆ–é«˜æ•ˆå‹ç¼©
          5. **é›¶å†—ä½™**: åˆ é™¤æ‰€æœ‰æ–‡æ¡£ã€è¯­è¨€æ–‡ä»¶ã€è°ƒè¯•ä¿¡æ¯
          
          ## ğŸ“– ä½¿ç”¨æ–¹æ³•
          ```bash
          # å†™å…¥Uç›˜
          dd if=openwrt-ultra-minimal.iso of=/dev/sdX bs=4M status=progress
          
          # æˆ–ä½¿ç”¨å›¾å½¢å·¥å…·
          # - Etcher: https://www.balena.io/etcher/
          # - Rufus: https://rufus.ie/
          # - Ventoy: https://www.ventoy.net/
          ```
          
          ## ğŸ”§ æ‰‹åŠ¨æ“ä½œ
          å¦‚éœ€æ‰‹åŠ¨å®‰è£…æˆ–æ•…éšœæ’æŸ¥:
          ```bash
          # å¯åŠ¨åé€‰æ‹©"Emergency Shell"
          # æ‰‹åŠ¨æŒ‚è½½å¹¶å®‰è£…
          mount /dev/sr0 /mnt
          /mnt/img/installer.sh
          ```
          
          ## ğŸ§ª å·²éªŒè¯åŠŸèƒ½
          - [x] QEMU BIOS/UEFIå¼•å¯¼
          - [x] å®ä½“æœºBIOSå¼•å¯¼
          - [x] å®ä½“æœºUEFIå¼•å¯¼
          - [x] å¤šç§ç£ç›˜ç±»å‹ (SATA/NVMe/USB)
          - [x] ä½å†…å­˜ç¯å¢ƒ (256MB RAM)
          
          ## ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡
          - **å¯åŠ¨æ—¶é—´**: < 10ç§’ (UEFI)
          - **å†…å­˜å ç”¨**: < 32MB (è¿è¡Œä¸­)
          - **ISOå¤§å°**: é€šå¸¸ < 100MB
          - **å…¼å®¹æ€§**: 2008å¹´åçš„å¤§éƒ¨åˆ†x86ç¡¬ä»¶
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          1. å®‰è£…ä¼š**å®Œå…¨æ“¦é™¤**ç›®æ ‡ç£ç›˜
          2. ç¡®ä¿å¤‡ä»½é‡è¦æ•°æ®
          3. æ¨è8GBä»¥ä¸ŠUç›˜
          4. UEFIå®‰å…¨å¯åŠ¨å¯èƒ½éœ€è¦ç¦ç”¨
          
          ---
          *ç”±GitHub Actionsè‡ªåŠ¨æ„å»º - æè‡´å‹ç¼©æ–¹æ¡ˆ*
