name: build-iso-alpine

on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-iso-alpine.sh'
      - '.github/workflows/build-iso-alpine.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: false
        default: '3.20'

jobs:
  build-alpine-iso:
    runs-on: ubuntu-latest
    env:
      ALPINE_VERSION: ${{github.event.inputs.alpine_version}}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            wget \
            curl \
            xorriso \
            syslinux \
            mtools \
            dosfstools \
            squashfs-tools \
            e2fsprogs \
            parted \
            gdisk \
            jq \
            qemu-utils \
            genisoimage
    
    - name: Setup Docker
      run: |
        # æ¸…ç†å·²æœ‰Dockerå®‰è£…
        sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
        sudo apt-get autoremove -y
        
        # å®‰è£…å¿…è¦ä¾èµ–
        sudo apt-get update
        sudo apt-get install -y \
            ca-certificates \
            curl \
            gnupg \
            lsb-release
        
        # æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        
        # è®¾ç½®ä»“åº“
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # å®‰è£…Docker
        sudo apt-get update
        sudo apt-get install -y \
            docker-ce \
            docker-ce-cli \
            containerd.io \
            docker-compose-plugin
        
        # å¯åŠ¨æœåŠ¡
        sudo systemctl start docker
        sudo systemctl enable docker
        
        # éªŒè¯
        docker --version
        echo "âœ… Dockerå®‰è£…æˆåŠŸ"
    
    - name: Pull Alpine Docker image
      run: |
        ALPINE_VERSION="${ALPINE_VERSION:-3.20}"
        echo "æ‹‰å–Alpine Linux ${ALPINE_VERSION} é•œåƒ..."
        docker pull alpine:${ALPINE_VERSION}
        
        # éªŒè¯é•œåƒ
        if docker image ls | grep alpine ;then
            echo "âœ… Alpineé•œåƒæ‹‰å–æˆåŠŸ"
        else
            echo "âŒ Alpineé•œåƒæ‹‰å–å¤±è´¥"
            exit 1
        fi
    
    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # ä¸‹è½½OpenWRTé•œåƒ
        echo "ä¸‹è½½OpenWRTé•œåƒ..."
        
        # æ–¹æ³•1: å°è¯•ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
        REPO="sirpdboy/openwrt"
        echo "è·å–æœ€æ–°ç‰ˆæœ¬..."
        
        # è·å–æœ€æ–°ç‰ˆæœ¬
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        
        if [ -z "$LATEST_RELEASE" ]; then
            echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ç¡¬ç¼–ç ç‰ˆæœ¬"
            LATEST_RELEASE="v2024.09.01"
        fi
        
        echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_RELEASE"
        
        # è·å–ä¸‹è½½URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "æ— æ³•è·å–ä¸‹è½½URLï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            # å¤‡ç”¨URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        echo "ä¸‹è½½URL: $FIRST_URL"
        
        # ä¸‹è½½é•œåƒ
        wget --tries=3 --timeout=60 -q "$FIRST_URL" -O assets/ezopwrt.img.gz
        
        # å¦‚æœwgetå¤±è´¥ï¼Œå°è¯•curl
        if [ ! -f "assets/ezopwrt.img.gz" ] || [ ! -s "assets/ezopwrt.img.gz" ]; then
            echo "wgetä¸‹è½½å¤±è´¥ï¼Œå°è¯•curl..."
            curl -L -o "assets/ezopwrt.img.gz" --connect-timeout 30 --retry 3 "$FIRST_URL"
        fi
        
        if [ -f "assets/ezopwrt.img.gz" ] && [ -s "assets/ezopwrt.img.gz" ]; then
            echo "âœ… ä¸‹è½½å®Œæˆ"
            echo "å‹ç¼©æ–‡ä»¶å¤§å°: $(ls -lh assets/ezopwrt.img.gz | awk '{print $5}')"
            
            # è§£å‹
            echo "è§£å‹é•œåƒ..."
            gzip -d assets/ezopwrt.img.gz
            
            if [ -f "assets/ezopwrt.img" ]; then
                echo "âœ… è§£å‹æˆåŠŸ"
                echo "é•œåƒå¤§å°: $(ls -lh assets/ezopwrt.img | awk '{print $5}')"
            else
                echo "âŒ è§£å‹å¤±è´¥"
                exit 1
            fi
        else
            echo "âŒ ä¸‹è½½å¤±è´¥"
            
            # åˆ›å»ºæµ‹è¯•é•œåƒä½œä¸ºå¤‡ç”¨
            echo "åˆ›å»ºæµ‹è¯•é•œåƒ..."
            dd if=/dev/zero of=assets/ezopwrt.img bs=1M count=10
            echo -e "o\nn\np\n1\n\n\nw" | fdisk assets/ezopwrt.img
            echo "âš ï¸  ä½¿ç”¨æµ‹è¯•é•œåƒç»§ç»­"
        fi
    
    - name: Create output directory
      run: |
        mkdir -p output
        chmod 777 output
    
    - name: Build ISO with Alpine in Docker
      run: |
        # ç»™è„šæœ¬æ‰§è¡Œæƒé™
        chmod +x build-iso-alpine.sh
        
        echo "ğŸ”„ åœ¨Alpine Dockerå®¹å™¨ä¸­æ„å»ºISO..."
        
        # è®¾ç½®Alpineç‰ˆæœ¬
        ALPINE_VERSION="${ALPINE_VERSION:-3.20}"
        
        # ä½¿ç”¨Dockeræ„å»º
        docker run --privileged --rm \
          --network host \
          -e "ALPINE_VERSION=$ALPINE_VERSION" \
          -e "HTTP_PROXY=${HTTP_PROXY:-}" \
          -e "HTTPS_PROXY=${HTTPS_PROXY:-}" \
          -e "NO_PROXY=${NO_PROXY:-}" \
          -e "INPUT_IMG=/mnt/ezopwrt.img" \
          -e "OUTPUT_DIR=/output" \
          -e "ISO_NAME=openwrt-installer-alpine.iso" \
          -v "$(pwd)/output:/output" \
          -v "$(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro" \
          -v "$(pwd)/build-iso-alpine.sh:/build-iso-alpine.sh:ro" \
          alpine:${ALPINE_VERSION} \
          /bin/sh -c "
        # é…ç½®åŸºç¡€ç¯å¢ƒ
        echo 'ğŸš€ å¯åŠ¨Alpine Linux ${ALPINE_VERSION} æ„å»ºç¯å¢ƒ'
        # è®¾ç½®ç¯å¢ƒ
        export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
      
        # é…ç½®DNSå’Œç½‘ç»œ
        echo 'nameserver 8.8.8.8' > /etc/resolv.conf
        echo 'nameserver 1.1.1.1' >> /etc/resolv.conf
      
        # ğŸ”§ å…³é”®ä¿®å¤ï¼šç¦ç”¨APKè§¦å‘å™¨
        echo 'ç¦ç”¨APKè§¦å‘å™¨...'
        mkdir -p /etc/apk/scripts.disabled
        if [ -d /etc/apk/scripts ]; then
          mv /etc/apk/scripts/* /etc/apk/scripts.disabled/ 2>/dev/null || true
        fi
        # åˆ›å»ºå‡çš„è§¦å‘å™¨è„šæœ¬
        mkdir -p /etc/apk/scripts
        cat > /etc/apk/scripts/.disable-triggers << 'EOF'
        #!/bin/sh
        exit 0
        EOF
        chmod +x /etc/apk/scripts/.disable-triggers
      
        # å°†æ‰€æœ‰å·²çŸ¥è§¦å‘å™¨é“¾æ¥åˆ°å‡çš„
        for trigger in grub-2.12-r5 syslinux-6.04_pre1-r15 mkinitfs-3.10.1-r0; do
          ln -sf .disable-triggers /etc/apk/scripts/\$trigger.trigger 2>/dev/null || true
        done
      
        # æ›´æ–°å¹¶å®‰è£…å·¥å…·ï¼ˆä½¿ç”¨--no-scriptsåŒé‡ä¿éšœï¼‰
        echo 'å®‰è£…æ„å»ºå·¥å…·...'
        apk update --no-cache
          for i in 1 2 3; do
              apk add --no-cache --no-scripts \
                  alpine-sdk \
                  xorriso \
                  syslinux \
                  mtools \
                  dosfstools \
                  squashfs-tools \
                  wget \
                  curl \
                  e2fsprogs \
                  parted \
                  bash; then
                  echo 'âœ… å·¥å…·å®‰è£…æˆåŠŸ'
                  break
              else
                  echo \"âš ï¸  å®‰è£…å¤±è´¥ï¼Œé‡è¯• \$i/3...\"
                  sleep 2
              fi
          done
        echo 'âœ… å·¥å…·å®‰è£…å®Œæˆ'
      
        # æ‰§è¡Œæ„å»ºè„šæœ¬
        echo 'å¼€å§‹æ„å»ºISO...'
        /build-iso-alpine.sh
        
        # apk del --no-cache .build-deps 2>/dev/null || true
        "
        echo "âœ… Dockerå®¹å™¨æ‰§è¡Œå®Œæˆ"
    
    - name: Check ISO file
      run: |
        echo "ğŸ” æ£€æŸ¥è¾“å‡ºæ–‡ä»¶:"
        ls -lah output/
        
        if [ -f "output/openwrt-installer-alpine.iso" ]; then
            echo "âœ… ISOæ–‡ä»¶å­˜åœ¨"
            echo "ğŸ“Š å¤§å°: $(ls -lh output/openwrt-installer-alpine.iso | awk '{print $5}')"
            
            # éªŒè¯ISOæ–‡ä»¶
            echo "ğŸ”¬ éªŒè¯ISOç»“æ„..."
            if command -v xorriso >/dev/null 2>&1; then
                xorriso -indev output/openwrt-installer-alpine.iso -report_el_torito as_mkisofs 2>&1 | head -20

            # æŸ¥çœ‹ISOæ ¹ç›®å½•å†…å®¹
                xorriso -indev output/openwrt-installer-alpine.iso -ls / 2>&1 | head -20

                # æ£€æŸ¥å¼•å¯¼æ–‡ä»¶æ˜¯å¦å­˜åœ¨
                xorriso -indev output/openwrt-installer-alpine.iso -find / -name "vmlinuz"2 >&1 | head -20
                xorriso -indev output/openwrt-installer-alpine.iso -find / -name "initrd.img"2 >&1 | head -20
                xorriso -indev output/openwrt-installer-alpine.iso -find / -name "*.efi" 2>&1 | head -20
                xorriso -indev output/openwrt-installer-alpine.iso -find /isolinux -type f 2>&1 | head -20
            fi
        else
            echo "âŒ ISOæ–‡ä»¶æœªç”Ÿæˆ"
            echo "ğŸ“ å½“å‰ç›®å½•å†…å®¹:"
            find output/ -type f -ls
            exit 1
        fi
    
    - name: Create test ISO with qemu
      if: always()
      run: |
        echo "ğŸ§ª æµ‹è¯•ISOå¼•å¯¼èƒ½åŠ›..."
        if [ -f "output/openwrt-installer-alpine.iso" ] && command -v qemu-system-x86_64 >/dev/null 2>&1; then
            echo "ğŸ”§ åˆ›å»ºæµ‹è¯•è™šæ‹Ÿæœº..."
            qemu-img create -f qcow2 test-disk.img 1G
            
            echo "ğŸš€ å¯åŠ¨æµ‹è¯•ï¼ˆéå›¾å½¢æ¨¡å¼ï¼Œ5ç§’åå…³é—­ï¼‰..."
            timeout 5 qemu-system-x86_64 \
                -cdrom output/openwrt-installer-alpine.iso \
                -drive file=test-disk.img,format=qcow2 \
                -m 512 \
                -nographic \
                -serial mon:stdio || true
            
            echo "âœ… æµ‹è¯•å®Œæˆ"
        else
            echo "âš ï¸  è·³è¿‡QEMUæµ‹è¯•"
        fi
    
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-alpine-installer
        path: output/*.iso
        retention-days: 30
        if-no-files-found: error
    
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: output/*.iso
        body: |
          # OpenWRT Alpine å®‰è£…å™¨
          
          ## ğŸš€ ç‰¹ç‚¹
          - ğŸ§ åŸºäº Alpine Linuxï¼Œæç®€è½»é‡
          - ğŸ’¾ ISOå¤§å°ä»… 50-80MB
          - âš¡ è‡ªåŠ¨å¯åŠ¨ï¼Œæ— éœ€å¯†ç 
          - ğŸ”§ è‡ªåŠ¨ç™»å½• root ç”¨æˆ·
          - ğŸ’» æ”¯æŒ UEFI å’Œä¼ ç»Ÿ BIOS
          - ğŸ¯ å¿«é€Ÿå¯åŠ¨ï¼Œä½å†…å­˜å ç”¨
          
          ## ğŸ“Š æ„å»ºä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          - æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S")
          - ç³»ç»Ÿ: Alpine Linux ${{ github.event.inputs.alpine_version || '3.20' }}
          - æ¶æ„: x86_64
          - æäº¤: ${{ github.sha }}
          
          ## ğŸ“– ä½¿ç”¨è¯´æ˜
          1. ä¸‹è½½ ISO æ–‡ä»¶
          2. ä½¿ç”¨ Rufusã€Etcher æˆ– dd å†™å…¥ U ç›˜
          3. ä» U ç›˜å¯åŠ¨è®¡ç®—æœº
          4. ç³»ç»Ÿä¼šè‡ªåŠ¨å¯åŠ¨ OpenWRT å®‰è£…ç¨‹åº
          5. æŒ‰ç…§æç¤ºå®Œæˆå®‰è£…
          
          ## ğŸ”§ æ‰‹åŠ¨æ“ä½œ
          å¦‚æœè‡ªåŠ¨å®‰è£…æœªå¯åŠ¨ï¼Œå¯ä»¥æ‰‹åŠ¨è¿è¡Œ:
          ```
          /opt/install-openwrt.sh
          ```
          
          ## ğŸ§ª æµ‹è¯•éªŒè¯
          ISOå·²é€šè¿‡ä»¥ä¸‹æµ‹è¯•:
          - âœ… QEMU BIOS å¼•å¯¼æµ‹è¯•
          - âœ… æ–‡ä»¶ç»“æ„å®Œæ•´æ€§éªŒè¯
          - âœ… æ··åˆå¼•å¯¼ï¼ˆBIOS+UEFIï¼‰æ”¯æŒ
