name: build-iso-alpine

on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-iso-alpine.sh'
      - '.github/workflows/build-iso-alpine.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: false
        default: '3.20'

jobs:
  build-small:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
            wget \
            curl \
            xorriso \
            syslinux \
            mtools \
            dosfstools \
            squashfs-tools \
            e2fsprogs \
            parted \
            gdisk \
            jq
    
    - name: Setup Docker (Fixed)
      run: |
        # æ¸…ç†å·²æœ‰Dockerå®‰è£…
        sudo apt-get remove -y docker docker-engine docker.io containerd runc 2>/dev/null || true
        sudo apt-get autoremove -y
        
        # å®‰è£…å¿…è¦ä¾èµ–
        sudo apt-get update
        sudo apt-get install -y \
            ca-certificates \
            curl \
            gnupg \
            lsb-release
        
        # æ·»åŠ Dockerå®˜æ–¹GPGå¯†é’¥
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        
        # è®¾ç½®ä»“åº“
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        
        # å®‰è£…Docker
        sudo apt-get update
        sudo apt-get install -y \
            docker-ce \
            docker-ce-cli \
            containerd.io \
            docker-compose-plugin
        
        # å¯åŠ¨æœåŠ¡
        sudo systemctl start docker
        sudo systemctl enable docker
        
        # éªŒè¯
        docker --version
        echo "âœ… Dockerå®‰è£…æˆåŠŸ"
    
    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # ä½¿ç”¨ä½ çš„ä¸‹è½½è„šæœ¬æˆ–ç›´æ¥ä¸‹è½½
        if [ -f scripts/download-image.sh ]; then
          chmod +x scripts/download-image.sh
          ./scripts/download-image.sh
        else
          echo "ä¸‹è½½OpenWRTé•œåƒ..."
          REPO="sirpdboy/openwrt"
          TAG=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
          DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
                jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url')
          FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
          echo "ä¸‹è½½: $FIRST_URL"
          wget -q $FIRST_URL  -O assets/ezopwrt.img.gz
           if [ ! -f "assets/ezopwrt.img.gz" ]; then
             curl -L -o "$OUTPUT_FILE"  --progress-bar --retry 3 "$FIRST_URL" 
           fi
        
           if [ $? -eq 0 ]; then
               echo "âœ… ä¸‹è½½å®Œæˆ"
               gzip -d assets/ezopwrt.img.gz
            fi
        fi
        echo "âœ… é•œåƒå¤§å°: $(stat -c%s assets/ezopwrt.img | numfmt --to=iec)"
    
    - name: Create output directory
      run: |
        mkdir -p output
        chmod 777 output
    - name: Build small ISO with Alpine in Docker
      run: |
        chmod +x build-iso-alpine.sh
        
        # åœ¨Alpine Dockerå®¹å™¨ä¸­è¿è¡Œæ„å»º
        docker run --privileged --rm \
          -v $(pwd)/output:/output \
          -v $(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro \
          -v $(pwd)/build-iso-alpine.sh:/build-iso-alpine.sh:ro \
          alpine:3.20 \
          sh -c "
          # å®‰è£…å¿…è¦å·¥å…·
          apk update
          apk add --no-cache \
            alpine-sdk \
            xorriso \
            syslinux \
            mtools \
            dosfstools \
            squashfs-tools \
            wget \
            curl \
            e2fsprogs \
            parted \
            grub grub-efi \
            bash
          
          # æ‰§è¡Œæ„å»ºè„šæœ¬
          /build-iso-alpine.sh
          "
    
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-alpine
        path: output/*.iso
        retention-days: 30
        if-no-files-found: error
    
    - name: Create release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: output/*.iso
        body: |
          # å°å‹OpenWRTå®‰è£…å™¨ (åŸºäºAlpine Linux)
          
          ## ç‰¹ç‚¹
          - ğŸ§ åŸºäºAlpine Linuxï¼Œéå¸¸è½»é‡
          - ğŸ“¦ ISOå¤§å°ä»…50-80MB
          - ğŸš€ è‡ªåŠ¨å¯åŠ¨å®‰è£…ç¨‹åº
          - ğŸ”§ æ— éœ€ç”¨æˆ·åå¯†ç 
          - ğŸ’¾ æ”¯æŒUEFIå’Œä¼ ç»ŸBIOS
          
          ## æ„å»ºä¿¡æ¯
          - ç‰ˆæœ¬: ${{ github.ref_name }}
          - æ—¶é—´: $(date -u)
          - å¤§å°: $(ls -lh output/*.iso | awk '{print $5}')
          - æäº¤: ${{ github.sha }}
