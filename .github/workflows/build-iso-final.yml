name: build-iso-final


on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-iso-final.sh'
      - '.github/workflows/build-iso-final.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'ubuntu版本'
        required: false
        default: '3.20'
jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # 使用你的下载脚本或直接下载
        if [ -f scripts/download-image.sh ]; then
          chmod +x scripts/download-image.sh
          ./scripts/download-image.sh
        else
          echo "下载OpenWRT镜像..."
          REPO="sirpdboy/openwrt"
          TAG=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
          DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
                jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url')
          FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
          echo "下载: $FIRST_URL"
          wget -q $FIRST_URL  -O assets/ezopwrt.img.gz
           if [ ! -f "assets/ezopwrt.img.gz" ]; then
             curl -L -o "$OUTPUT_FILE"  --progress-bar --retry 3 "$FIRST_URL" 
           fi
        
           if [ $? -eq 0 ]; then
               echo "✅ 下载完成"
               gzip -d assets/ezopwrt.img.gz
            fi
            
        fi
        echo "✅ 镜像大小: $(stat -c%s assets/ezopwrt.img | numfmt --to=iec)"

    - name: Create output directory
      run: |
        mkdir -p output
        chmod 777 output
    - name: Build ISO with proper rootfs
      run: |
        chmod +x build-iso-final.sh
    
        docker run --privileged --rm \
        -v $(pwd)/output:/output \
        -v $(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro \
        -v $(pwd)/build-iso-final.sh:/build-iso.sh:ro \
        debian:buster-slim \
        bash -c "
        # 配置archive源
        echo 'deb http://archive.debian.org/debian buster main' > /etc/apt/sources.list
        echo 'Acquire::Check-Valid-Until \"false\";' > /etc/apt/apt.conf.d/99no-check-valid-until
        echo 'APT::Get::AllowUnauthenticated \"true\";' >> /etc/apt/apt.conf.d/99no-check-valid-until
      
        # 安装必要工具（不安装live-boot）
        apt-get update
        apt-get install -y --allow-unauthenticated \
        debootstrap squashfs-tools xorriso isolinux \
        grub-pc-bin grub-efi-amd64-bin mtools dosfstools parted wget curl cpio 
       
        /build-iso.sh
        "
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: ezopwrt-installer
        path: output/*.iso
        retention-days: 30

