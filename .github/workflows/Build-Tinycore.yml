name: Build-Tinycore


on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-tinycore.sh'
      - '.github/workflows/Build-Tinycore.yml'
  workflow_dispatch:
    inputs:
      openwrt_image_url:
        description: 'OpenWRTé•œåƒURLï¼ˆå¯é€‰ï¼‰'
        required: false

jobs:
  build:
    runs-on: ubuntu-22.04  # GitHub Actionså·²ç»é¢„è£…äº†Docker
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Dockerç¯å¢ƒ
      run: |
        echo "ğŸ³ Dockerç¯å¢ƒæ£€æŸ¥..."
        docker --version
        docker info | grep -E "(Server Version|Containers|Images)"
        echo "âœ… Dockerç¯å¢ƒæ­£å¸¸"
    
    - name: å‡†å¤‡æ„å»ºæ–‡ä»¶
      run: |
        # åˆ›å»ºä¿®å¤åçš„Dockerfile
        cat > Dockerfile.openwrt-builder << 'DOCKEREOF'
        FROM ubuntu:22.04
        
        # è®¾ç½®éäº¤äº’æ¨¡å¼
        ENV DEBIAN_FRONTEND=noninteractive
        
        # å®‰è£…æ„å»ºå·¥å…·ï¼ˆä½¿ç”¨æ­£ç¡®çš„åŒ…åï¼‰
        RUN apt-get update && apt-get install -y \
            genisoimage \
            syslinux \
            isolinux \
            squashfs-tools \
            pv \
            xorriso \
            mtools \
            dosfstools \
            # GRUBå¼•å¯¼å·¥å…·
            grub-pc-bin \
            grub-efi-amd64-bin \
            grub-efi-ia32-bin \
            grub2-common \
            wget \
            curl \
            xz-utils \
            zstd \
            lz4 \
            upx-ucl \
            cpio \
            gzip \
            file \
            findutils \
            coreutils \
            jq \
            # ç½‘ç»œå·¥å…·
            iproute2 \
            net-tools \
            && rm -rf /var/lib/apt/lists/*
        
        # æ£€æŸ¥å¹¶å®‰è£…mkisofsï¼ˆå¦‚æœgenisoimageæœªæä¾›ï¼‰
        RUN if ! command -v mkisofs >/dev/null 2>&1 && ! command -v genisoimage >/dev/null 2>&1; then \
            apt-get update && apt-get install -y mkisofs; \
        fi
        
        # åˆ›å»ºå·¥ä½œç›®å½•
        WORKDIR /builder
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•
        RUN mkdir -p /mnt /output
        
        # è®¾ç½®æ„å»ºè„šæœ¬ï¼ˆå°†åœ¨è¿è¡Œæ—¶æŒ‚è½½ï¼‰
        ENTRYPOINT ["bash", "-c"]
        CMD ["echo 'è¯·æŒ‚è½½æ„å»ºè„šæœ¬å¹¶è¿è¡Œ'"]
        DOCKEREOF
    
    - name: å‡†å¤‡OpenWRTé•œåƒ
      id: prepare_image
      run: |
        echo "ğŸ“¥ å‡†å¤‡OpenWRTé•œåƒ..."
        
        # åˆ›å»ºç›®å½•
        mkdir -p assets
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æä¾›çš„URL
        if [[ -n "${{ github.event.inputs.openwrt_image_url }}" ]]; then
            echo "ä½¿ç”¨æä¾›çš„OpenWRT URL"
            OPENWRT_URL="${{ github.event.inputs.openwrt_image_url }}"
        else
            # ä½¿ç”¨é»˜è®¤é•œåƒ
            OPENWRT_URL="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        echo "ä¸‹è½½URL: $OPENWRT_URL"
        
        # ä¸‹è½½é•œåƒ
        if wget -q --tries=3 --timeout=30 -O "assets/ezopwrt.img.gz" "$OPENWRT_URL"; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
            
            # è§£å‹
            if gzip -t "assets/ezopwrt.img.gz" 2>/dev/null; then
                echo "è§£å‹gzipæ–‡ä»¶..."
                gzip -d "assets/ezopwrt.img.gz"
                echo "âœ… è§£å‹å®Œæˆ"
            else
                echo "ä¸æ˜¯gzipæ–‡ä»¶ï¼Œç›´æ¥ä½¿ç”¨"
                mv "assets/ezopwrt.img.gz" "assets/ezopwrt.img"
            fi
            
            # éªŒè¯æ–‡ä»¶
            if [ -f "assets/ezopwrt.img" ]; then
                IMG_SIZE=$(du -h "assets/ezopwrt.img" | cut -f1)
                echo "é•œåƒå¤§å°: $IMG_SIZE"
                echo "img_path=assets/ezopwrt.img" >> $GITHUB_OUTPUT
            else
                echo "âŒ é•œåƒæ–‡ä»¶åˆ›å»ºå¤±è´¥"
                exit 1
            fi
        else
            echo "âŒ ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºæµ‹è¯•é•œåƒ"
            dd if=/dev/zero of=assets/ezopwrt.img bs=1M count=10
            echo "img_path=assets/ezopwrt.img" >> $GITHUB_OUTPUT
        fi

    - name: è¿è¡ŒISOæ„å»º
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºISO..."
     
        echo "å®‰è£…æ„å»ºå·¥å…·..."
        sudo apt-get update
            sudo apt-get install -y \
                genisoimage \
                xorriso \
                # å¼•å¯¼å·¥å…·
                syslinux \
                isolinux \
                # æ–‡ä»¶ç³»ç»Ÿå·¥å…·
                squashfs-tools \
                mtools \
                dosfstools \
                # GRUBå¼•å¯¼ï¼ˆUbuntu 24.04æ–°åŒ…åï¼‰
                grub-common \
                grub-efi-amd64-bin \
                grub-efi-ia32-bin \
                # å·¥å…·
                wget \
                curl \
                xz-utils \
                cpio \
                gzip \
                file \
                jq \
                pv \
                # ç½‘ç»œå·¥å…·
                iproute2 \
                net-tools \
            chmod +x build-tinycore.sh
    
            # è¿è¡Œæ„å»º
            mkdir -p output
            chmod 777 output
    
            "./build-tinycore.sh" \
                "$(pwd)/assets/ezopwrt.img" \
                "$(pwd)/output" \
                "openwrt-installer.iso"
    
            # æ£€æŸ¥ç»“æœ
            if [ \$? -eq 0 ] && [ -f "output/openwrt-installer.iso" ]; then
                echo "âœ… ISOæ„å»ºæˆåŠŸ"
                echo "æ–‡ä»¶: output/openwrt-installer.iso"
                echo "å¤§å°: \$(du -h output/openwrt-installer.iso | cut -f1)"
            else
                echo "âŒ ISOæ„å»ºå¤±è´¥"
                echo "outputç›®å½•å†…å®¹:"
                ls -la output/ 2>/dev/null || echo "outputç›®å½•ä¸å­˜åœ¨"
                exit 1
            fi
    - name: è¿è¡ŒISOæ„å»º
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºISO..."
              chmod +x build-tinycore.sh
               # è¿è¡ŒDocker
            docker run --rm \
                -v "$(pwd)/assets/ezopwrt.img:/mnt/openwrt.img:ro" \
                -v "$(pwd)/build-tinycore.sh:/build.sh:ro" \
                -v "output:/output" \  
                ubuntu-22.04 \
        /docker-build.sh /mnt/openwrt.img /output openwrt-installer.iso

            # æ£€æŸ¥ç»“æœ
            if [ $? -eq 0 ]; then
                echo "âœ… ISOæ„å»ºå®Œæˆ"
                if [ -f "output/openwrt-installer.iso" ]; then
                    echo "ISOå¤§å°: \$(du -h output/openwrt-installer.iso | cut -f1)"
                fi
            else
                echo "âŒ ISOæ„å»ºå¤±è´¥"
                exit 1
            fi
    

    - name: éªŒè¯ISOæ–‡ä»¶
      run: |
        if ls output/*.iso 1>/dev/null 2>&1; then
            ISO_FILE=$(ls output/*.iso)
            echo "âœ… ISOæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $(basename $ISO_FILE)"
            echo "æ–‡ä»¶å¤§å°: $(du -h "$ISO_FILE" | cut -f1)"
            
            # åŸºæœ¬éªŒè¯
            echo ""
            echo "ISOæ–‡ä»¶éªŒè¯:"
            file "$ISO_FILE"
            
            # æ£€æŸ¥æ˜¯å¦æ”¯æŒBIOS/UEFI
            if command -v xorriso >/dev/null 2>&1; then
                echo ""
                echo "å¼•å¯¼ä¿¡æ¯:"
                xorriso -indev "$ISO_FILE" -toc 2>/dev/null | grep -E "(Bootable|El-Torito|UEFI)" || true
            fi
        else
            echo "âŒ æ²¡æœ‰ç”ŸæˆISOæ–‡ä»¶"
            exit 1
        fi

    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-iso
        path: output/*.iso
        retention-days: 7
