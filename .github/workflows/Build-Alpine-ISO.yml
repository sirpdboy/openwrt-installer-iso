name: Build-Alpine-ISO

on:
  push:
    branches: [ main, master ]
    paths:
      - 'scripts/**'
      - 'Dockerfile'
      - '.github/workflows/Build-Alpine-ISO.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpine版本 (例如: 3.18, 3.19, 3.20)'
        required: true
        default: '3.20'
      openwrt_version:
        description: 'OpenWRT版本标签'
        required: false
        default: 'latest'

env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}
  OPENWRT_VERSION: ${{ github.event.inputs.openwrt_version || 'latest' }}

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    
    - name: 设置执行权限
      run: |
        chmod +x scripts/*.sh
        chmod +x scripts/include/*.sh
      
    - name: 获取OpenWRT镜像
     
      run: |
        mkdir -p assets
        
        # 下载OpenWRT镜像
        echo "下载OpenWRT镜像..."
        
        # 方法1: 尝试下载最新版本
        REPO="sirpdboy/openwrt"
        echo "获取最新版本..."
        
        # 获取最新版本
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        
        if [ -z "$LATEST_RELEASE" ]; then
            echo "无法获取最新版本，使用硬编码版本"
            LATEST_RELEASE="v2024.09.01"
        fi
        
        echo "最新版本: $LATEST_RELEASE"
        
        # 获取下载URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "无法获取下载URL，使用备用方法"
            # 备用URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        echo "下载URL: $FIRST_URL"
        
        # 下载镜像
        wget --tries=3 --timeout=60 -q "$FIRST_URL" -O assets/openwrt.img.gz
        
        # 如果wget失败，尝试curl
        if [ ! -f "assets/openwrt.img.gz" ] || [ ! -s "assets/openwrt.img.gz" ]; then
            echo "wget下载失败，尝试curl..."
            curl -L -o "assets/openwrt.img.gz" --connect-timeout 30 --retry 3 "$FIRST_URL"
        fi
        
        if [ -f "assets/openwrt.img.gz" ] && [ -s "assets/openwrt.img.gz" ]; then
            echo "✅ 下载完成"
            echo "压缩文件大小: $(ls -lh assets/openwrt.img.gz | awk '{print $5}')"
            
            # 解压
            echo "解压镜像..."
            gzip -d assets/openwrt.img.gz
            
            if [ -f "assets/openwrt.img" ]; then
                echo "✅ 解压成功"
                echo "镜像大小: $(ls -lh assets/openwrt.img | awk '{print $5}')"
                
                echo "img_path=$(pwd)/assets/openwrt.img" >> $GITHUB_OUTPUT
            else
                echo "❌ 解压失败"
                exit 1
            fi
        else
            echo "❌ 下载失败"
            exit
        fi

    - name: 构建ISO
      run: |
        INPUT_IMG="${{ steps.prepare-openwrt.outputs.img_path }}"
        OUTPUT_DIR="$(pwd)/output"
        ISO_NAME="openwrt-installer-alpine-${{ env.ALPINE_VERSION }}-$(date +%Y%m%d).iso"
        
        echo "构建参数:"
        echo "  INPUT_IMG: $INPUT_IMG"
        echo "  OUTPUT_DIR: $OUTPUT_DIR"
        echo "  ISO_NAME: $ISO_NAME"
        
        mkdir -p "$OUTPUT_DIR"
        
        ./scripts/docker-build.sh "$INPUT_IMG" "$OUTPUT_DIR" "$ISO_NAME" "${{ env.ALPINE_VERSION }}"
        
        # 验证ISO
        if [ -f "$OUTPUT_DIR/$ISO_NAME" ]; then
            echo "✅ ISO构建成功"
            ls -lh "$OUTPUT_DIR/$ISO_NAME"
        else
            echo "❌ ISO构建失败"
            exit 1
        fi
    
    - name: 上传ISO文件
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-iso
        path: output/*.iso
        retention-days: 7
    
    - name: 输出构建信息
      run: |
        echo "=== 构建完成 ==="
        echo "Alpine版本: ${{ env.ALPINE_VERSION }}"
        echo "OpenWRT版本: ${{ env.OPENWRT_VERSION }}"
        echo ""
        echo "生成的文件:"
        ls -lh output/ 2>/dev/null || echo "output目录为空"
