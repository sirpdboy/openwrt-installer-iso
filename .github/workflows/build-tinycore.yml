name: build-tinycore


on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-tinycore.sh'
      - '.github/workflows/build-tinycore.yml'
  workflow_dispatch:
    inputs:
      openwrt_image_url:
        description: 'OpenWRTé•œåƒURLï¼ˆå¯é€‰ï¼‰'
        required: false

jobs:
  build:
    runs-on: ubuntu-22.04  # GitHub Actionså·²ç»é¢„è£…äº†Docker
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: è®¾ç½®Dockerç¯å¢ƒ
      run: |
        echo "ğŸ³ Dockerç¯å¢ƒæ£€æŸ¥..."
        docker --version
        docker info | grep -E "(Server Version|Containers|Images)"
        echo "âœ… Dockerç¯å¢ƒæ­£å¸¸"
    
    - name: å‡†å¤‡æ„å»ºæ–‡ä»¶
      run: |
        # åˆ›å»ºä¿®å¤åçš„Dockerfile
        cat > Dockerfile.openwrt-builder << 'DOCKEREOF'
        FROM ubuntu:22.04
        
        # è®¾ç½®éäº¤äº’æ¨¡å¼
        ENV DEBIAN_FRONTEND=noninteractive
        
        # å®‰è£…æ„å»ºå·¥å…·ï¼ˆä½¿ç”¨æ­£ç¡®çš„åŒ…åï¼‰
        RUN apt-get update && apt-get install -y \
            genisoimage \
            syslinux \
            isolinux \
            squashfs-tools \
            pv \
            xorriso \
            mtools \
            dosfstools \
            # GRUBå¼•å¯¼å·¥å…·
            grub-pc-bin \
            grub-efi-amd64-bin \
            grub-efi-ia32-bin \
            grub2-common \
            wget \
            curl \
            xz-utils \
            zstd \
            lz4 \
            upx-ucl \
            cpio \
            gzip \
            file \
            findutils \
            coreutils \
            jq \
            # ç½‘ç»œå·¥å…·
            iproute2 \
            net-tools \
            && rm -rf /var/lib/apt/lists/*
    
    - name: å‡†å¤‡OpenWRTé•œåƒ
      id: prepare_image
      run: |
        mkdir -p assets
        
        # ä¸‹è½½OpenWRTé•œåƒ
        echo "ä¸‹è½½OpenWRTé•œåƒ..."
        
        # æ–¹æ³•1: å°è¯•ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
        REPO="sirpdboy/openwrt"
        echo "è·å–æœ€æ–°ç‰ˆæœ¬..."
        
        # è·å–æœ€æ–°ç‰ˆæœ¬
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        
        if [ -z "$LATEST_RELEASE" ]; then
            echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ç¡¬ç¼–ç ç‰ˆæœ¬"
            LATEST_RELEASE="v2024.09.01"
        fi
        
        echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_RELEASE"
        
        # è·å–ä¸‹è½½URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "æ— æ³•è·å–ä¸‹è½½URLï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            # å¤‡ç”¨URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        echo "ä¸‹è½½URL: $FIRST_URL"
        
        # ä¸‹è½½é•œåƒ
        wget --tries=3 --timeout=60 -q "$FIRST_URL" -O assets/openwrt.img.gz
        
        # å¦‚æœwgetå¤±è´¥ï¼Œå°è¯•curl
        if [ ! -f "assets/openwrt.img.gz" ] || [ ! -s "assets/openwrt.img.gz" ]; then
            echo "wgetä¸‹è½½å¤±è´¥ï¼Œå°è¯•curl..."
            curl -L -o "assets/openwrt.img.gz" --connect-timeout 30 --retry 3 "$FIRST_URL"
        fi
        
        if [ -f "assets/openwrt.img.gz" ] && [ -s "assets/openwrt.img.gz" ]; then
            echo "âœ… ä¸‹è½½å®Œæˆ"
            echo "å‹ç¼©æ–‡ä»¶å¤§å°: $(ls -lh assets/openwrt.img.gz | awk '{print $5}')"
            
            # è§£å‹
            echo "è§£å‹é•œåƒ..."
            gzip -d assets/openwrt.img.gz
            
            if [ -f "assets/openwrt.img" ]; then
                echo "âœ… è§£å‹æˆåŠŸ"
                echo "é•œåƒå¤§å°: $(ls -lh assets/openwrt.img | awk '{print $5}')"
            else
                echo "âŒ è§£å‹å¤±è´¥"
                exit 1
          fi
        else
          echo "âŒ ä¸‹è½½å¤±è´¥"
            exit
        fi

    - name: è¿è¡ŒISOæ„å»º
      run: |
        echo "ğŸ”¨ å¼€å§‹æ„å»ºISO..."
     
        echo "å®‰è£…æ„å»ºå·¥å…·..."
        sudo apt-get update
        sudo apt-get install -y \
        genisoimage \
        xorriso \
        syslinux \
        isolinux \
        wget \
        curl \
                
            chmod +x build-tinycore.sh
    
            # è¿è¡Œæ„å»º
            mkdir -p output
            chmod 777 output
    
            "./build-tinycore.sh" \
                "$(pwd)/assets/ezopwrt.img" \
                "$(pwd)/output" \
                "openwrt-installer.iso"
    
    - name: éªŒè¯ISOæ–‡ä»¶
      run: |
        if ls output/*.iso 1>/dev/null 2>&1; then
            ISO_FILE=$(ls output/*.iso)
            echo "âœ… ISOæ–‡ä»¶ç”ŸæˆæˆåŠŸ: $(basename $ISO_FILE)"
            echo "æ–‡ä»¶å¤§å°: $(du -h "$ISO_FILE" | cut -f1)"
            
            # åŸºæœ¬éªŒè¯
            echo ""
            echo "ISOæ–‡ä»¶éªŒè¯:"
            file "$ISO_FILE"
            
            # æ£€æŸ¥æ˜¯å¦æ”¯æŒBIOS/UEFI
            if command -v xorriso >/dev/null 2>&1; then
                echo ""
                echo "å¼•å¯¼ä¿¡æ¯:"
                xorriso -indev "$ISO_FILE" -toc 2>/dev/null | grep -E "(Bootable|El-Torito|UEFI)" || true
            fi
        else
            echo "âŒ æ²¡æœ‰ç”ŸæˆISOæ–‡ä»¶"
            exit 1
        fi

    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-iso
        path: output/*.iso
        retention-days: 7
