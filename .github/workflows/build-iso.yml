name: Build OpenWRT Installer ISO

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 手动触发
    inputs:
      openwrt_version:
        description: 'OpenWRT版本号 (如: 23.05.2)'
        required: false
        default: 'latest'
      openwrt_image_url:
        description: 'OpenWRT镜像URL (可选)'
        required: false

env:
  ISO_NAME: "openwrt-installer"
  WORKSPACE: "/tmp/iso-build"
  
jobs:
  build:
    runs-on: ubuntu-22.04
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'
        fetch-depth: 0

    - name: Setup build environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          wget curl xorriso isolinux syslinux-efi \
          grub-pc-bin grub-efi-amd64-bin grub-efi-ia32-bin \
          mtools dosfstools squashfs-tools \
          p7zip-full git build-essential \
          kernel-package fakeroot libncurses5-dev libssl-dev \
          bc kmod cpio gcc g++ make libc6-dev

    - name: Download OpenWRT image
      id: download_image
      run: |
        mkdir -p ./assets
        
        # 如果有自定义URL，使用自定义URL
        if [[ -n "${{ github.event.inputs.openwrt_image_url }}" ]]; then
          echo "使用自定义镜像URL"
          wget -q "${{ github.event.inputs.openwrt_image_url }}" -O ./assets/openwrt.img
          
        # 否则下载官方OpenWRT镜像
        else
          # 获取最新稳定版
          if [[ "${{ github.event.inputs.openwrt_version }}" == "latest" ]]; then
            RELEASE=$(curl -s https://downloads.openwrt.org/releases/ | grep -E 'href="[0-9]+\.[0-9]+\.[0-9]+/"' | tail -1 | sed 's/.*href="\([^"]*\)".*/\1/' | tr -d '/')
          else
            RELEASE="${{ github.event.inputs.openwrt_version }}"
          fi
          
          echo "下载OpenWRT $RELEASE"
          # 下载x86_64通用镜像
          URL="https://downloads.openwrt.org/releases/${RELEASE}/targets/x86/64/openwrt-${RELEASE}-x86-64-generic-ext4-combined.img.gz"
          
          if ! wget -q --spider "$URL"; then
            # 尝试squashfs格式
            URL="https://downloads.openwrt.org/releases/${RELEASE}/targets/x86/64/openwrt-${RELEASE}-x86-64-generic-squashfs-combined.img.gz"
          fi
          
          wget -q "$URL" -O ./assets/openwrt.img.gz
          gunzip ./assets/openwrt.img.gz
        fi
        
        # 检查镜像大小
        IMG_SIZE=$(stat -c%s ./assets/openwrt.img)
        echo "镜像大小: $(($IMG_SIZE/1024/1024))MB"
        
        # 输出供后续步骤使用
        echo "img_size=$IMG_SIZE" >> $GITHUB_OUTPUT
        if [ -f ./assets/openwrt.img ]; then
          echo "image_downloaded=true" >> $GITHUB_OUTPUT
        else
          echo "image_downloaded=false" >> $GITHUB_OUTPUT
          exit 1
        fi

    - name: Run ISO build script
      run: |
        chmod +x ./scripts/*
        ./scripts/build-iso.sh
        
    - name: Verify ISO file
      run: |
        if [ -f "/tmp/${ISO_NAME}.iso" ]; then
          echo "ISO文件生成成功"
          ls -lh "/tmp/${ISO_NAME}.iso"
          # 验证ISO结构
          xorriso -indev "/tmp/${ISO_NAME}.iso" -toc 2>&1 | head -20
        else
          echo "错误: ISO文件未生成"
          exit 1
        fi

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-iso
        path: /tmp/${ISO_NAME}.iso
        retention-days: 7

    - name: Create GitHub Release (仅tag触发)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: /tmp/${ISO_NAME}.iso
        body: |
          OpenWRT安装ISO - 自动构建
          
          构建信息:
          - 时间: ${{ github.event.repository.updated_at }}
          - 提交: ${{ github.sha }}
          - 触发器: ${{ github.event_name }}
          
          使用说明:
          1. 下载ISO文件并写入USB: `dd if=openwrt-installer.iso of=/dev/sdX bs=4M status=progress`
          2. 从USB启动
          3. 按照提示安装OpenWRT

    - name: Deploy to Pages (可选)
      if: github.event_name == 'push' && github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./releases
        destination_dir: .
        keep_files: false
