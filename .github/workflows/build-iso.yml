name: Build EzOpWrt ISO

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Docker
      run: |
        sudo apt-get update
        sudo apt-get install -y docker.io
        sudo systemctl start docker
        sudo systemctl enable docker

    - name: Download OpenWRT image
      run: |
        mkdir -p assets
        
        # 使用你的下载脚本或直接下载
        if [ -f scripts/download-image.sh ]; then
          chmod +x scripts/download-image.sh
          ./scripts/download-image.sh
        else
          echo "下载OpenWRT镜像..."
          REPO="sirpdboy/openwrt"
          TAG=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
          DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
                jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url')
          FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
          echo "下载: $FIRST_URL"
          wget -q $FIRST_URL  -O assets/ezopwrt.img.gz
           if [ ! -f "assets/ezopwrt.img.gz" ]; then
             curl -L -o "$OUTPUT_FILE"  --progress-bar --retry 3 "$FIRST_URL" 
           fi
        
           if [ $? -eq 0 ]; then
               echo "✅ 下载完成"
               gzip -d assets/ezopwrt.img.gz
            fi
            
        fi
        echo "✅ 镜像大小: $(stat -c%s assets/ezopwrt.img | numfmt --to=iec)"

    - name: Create output directory
      run: |
        mkdir -p output
        chmod 777 output

    - name: Run Docker build
      run: |
        docker run --privileged --rm \
          -v $(pwd)/output:/output \
          -v $(pwd)/scripts:/scripts:ro \
          -v $(pwd)/assets/ezopwrt.img:/mnt/ezopwrt.img:ro \
          debian:bullseye-slim \
          /bin/bash -c "
          # 安装必要工具
          apt-get update && apt-get install -y \
            xorriso isolinux syslinux-efi \
            grub-pc-bin grub-efi-amd64-bin \
            mtools dosfstools squashfs-tools \
            wget curl cpio gzip jq \
            build-essential kmod file \
            && apt-get clean
          
          # 运行构建脚本
          /scripts/build-iso.sh
          "

    - name: Verify ISO
      run: |
        if ls output/*.iso 1> /dev/null 2>&1; then
          ISO_FILE=$(ls -t output/*.iso | head -1)
          echo "✅ ISO生成成功: $ISO_FILE"
          ls -lh output/
          
          # 验证ISO
          echo "ISO信息:"
          file "$ISO_FILE"
          echo "MD5: $(md5sum "$ISO_FILE" | cut -d' ' -f1)"
        else
          echo "❌ ISO生成失败"
          ls -la output/
          exit 1
        fi

    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: ezopwrt-installer
        path: output/*.iso
        retention-days: 30

    - name: Create GitHub Release (tag触发)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: output/*.iso
        body: |
          # EzOpWrt 安装器
          
          ## 构建信息
          - 版本: ${{ github.ref_name }}
          - 时间: $(date)
          - 提交: ${{ github.sha }}
          
          ## 使用说明
          1. 下载ISO文件
          2. 写入USB: `sudo dd if=ezopwrt-installer.iso of=/dev/sdX bs=4M status=progress`
          3. 从USB启动
          4. 按照屏幕提示安装
