name: ISO

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/ISO.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'ubuntu版本'
        required: false
        default: '3.20'

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Install essential tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          xorriso \
          genisoimage \
          wget \
          grub2-common \
          grub-pc-bin \
          syslinux-common \
          isolinux
        
    - name: Create and run build script
      run: |
        # 创建构建脚本
        cat > build-iso.sh << 'EOF'
        #!/bin/bash
        set -ex
        
        # 创建临时目录
        WORKDIR="/tmp/iso_build_$(date +%s)"
        OUTPUT="$GITHUB_WORKSPACE/iso_output"
        
        mkdir -p "$WORKDIR"
        mkdir -p "$OUTPUT"
        
        cd "$WORKDIR"
        
        # 1. 创建目录结构
        mkdir -p iso/boot/grub
        mkdir -p iso/kernel
        
        # 2. 下载内核
        cd iso/kernel
        echo "下载内核..."
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/netboot/vmlinuz-lts -O vmlinuz || \
        wget -q https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.18/releases/x86_64/netboot/vmlinuz-lts -O vmlinuz
        
        wget -q https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/netboot/initramfs-lts -O initrd.img || \
        wget -q https://mirrors.tuna.tsinghua.edu.cn/alpine/v3.18/releases/x86_64/netboot/initramfs-lts -O initrd.img
        
        # 3. GRUB配置
        cd ../boot/grub
        cat > grub.cfg << 'GRUBCFG'
        set timeout=3
        menuentry "Boot Live System" {
          linux /kernel/vmlinuz console=ttyS0
          initrd /kernel/initrd.img
        }
        GRUBCFG
        
        # 4. 检查文件
        cd "$WORKDIR/iso"
        echo "文件列表:"
        find . -type f
        
        # 5. 构建ISO - 方法1: 使用genisoimage
        cd "$WORKDIR"
        echo "构建ISO..."
        
        # 创建引导镜像
        if [ -f /usr/lib/grub/i386-pc/boot.img ]; then
            cp /usr/lib/grub/i386-pc/boot.img iso/boot/grub/
        fi
        
        # 使用genisoimage构建
        genisoimage \
          -o "$OUTPUT/minimal-live.iso" \
          -b boot/grub/boot.img \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          -V "LIVE_CD" \
          iso 2>/dev/null || true
        
        # 如果失败，尝试更简单的方法
        if [ ! -f "$OUTPUT/minimal-live.iso" ]; then
            echo "方法1失败，尝试方法2..."
            cd iso
            xorriso \
              -as mkisofs \
              -o "$OUTPUT/minimal-live.iso" \
              -b boot/grub/boot.img \
              -no-emul-boot \
              . 2>/dev/null || true
        fi
        
        # 检查结果
        if [ -f "$OUTPUT/minimal-live.iso" ]; then
            echo "✓ ISO构建成功"
            ls -lh "$OUTPUT/minimal-live.iso"
            file "$OUTPUT/minimal-live.iso"
        else
            echo "✗ ISO构建失败"
            exit 1
        fi
        EOF
        
        chmod +x build-iso.sh
        ./build-iso.sh
        
    - name: Verify ISO
      run: |
        echo "=== 验证ISO ==="
        
        if [ -f "iso_output/minimal-live.iso" ]; then
            echo "ISO文件存在"
            ls -lh iso_output/minimal-live.iso
            echo ""
            echo "文件类型:"
            file iso_output/minimal-live.iso || true
        else
            echo "错误: ISO文件不存在"
            ls -la iso_output/ 2>/dev/null || echo "输出目录不存在"
            exit 1
        fi
        
    - name: Quick test with QEMU
      run: |
        echo "=== 快速测试 ==="
        
        # 安装qemu进行测试
        sudo apt-get install -y qemu-system-x86 > /dev/null 2>&1
        
        if [ -f "iso_output/minimal-live.iso" ]; then
            echo "测试ISO引导..."
            timeout 3 qemu-system-x86_64 \
                -cdrom iso_output/minimal-live.iso \
                -m 256 \
                -boot d \
                -serial stdio \
                -display none \
                2>&1 | grep -i "booting\|CD-ROM" || echo "测试完成"
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: minimal-live-iso
        path: iso_output/minimal-live.iso
        if-no-files-found: error
        retention-days: 7
