name: ISO


on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/ISO.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpine版本'
        required: true
        default: '3.20'
env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          grub2-common \
          grub-pc-bin \
          xorriso \
          wget
        
    - name: Create ISO directory structure
      run: |
        # 创建干净的目录结构
        rm -rf iso_root
        mkdir -p iso_root/{boot/grub,kernel}
        
    - name: Download minimal kernel
      run: |
        cd iso_root/kernel
        # 使用Alpine Linux的小内核
        wget -q -O vmlinuz https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/boot/vmlinuz-lts
        wget -q -O initrd.img https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/boot/initramfs-lts
        echo "Kernel files downloaded:"
        ls -lh
        
    - name: Create GRUB configuration
      run: |
        cd iso_root/boot/grub
        cat > grub.cfg << 'EOF'
        set timeout=10
        set default=0

        menuentry "Minimal Live Shell" {
          echo "Loading kernel..."
          linux /kernel/vmlinuz console=ttyS0 console=tty0 init=/bin/sh
          echo "Loading initrd..."
          initrd /kernel/initrd.img
        }
        EOF
        echo "GRUB config created:"
        cat grub.cfg
        
    - name: Prepare BIOS boot image
      run: |
        # 复制BIOS引导镜像
        cp /usr/lib/grub/i386-pc/boot.img iso_root/boot/grub/
        
    - name: Build ISO with xorriso (FIXED)
      run: |
        # 进入iso_root的父目录，确保路径正确
        cd iso_root
        ISO_NAME="minimal-shell-$(date +%Y%m%d-%H%M).iso"
        
        echo "Building ISO from: $(pwd)"
        echo "Directory contents:"
        find . -type f | sort
        
        # 关键修复：使用正确的相对路径
        xorriso -as mkisofs \
          -r \
          -V "MINIMAL_SHELL" \
          -o "../${ISO_NAME}" \
          -iso-level 3 \
          -J \
          -b boot/grub/boot.img \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          .
        
        cd ..
        echo "=== ISO Build Complete ==="
        ls -lh *.iso
        echo "ISO size: $(du -h *.iso | cut -f1)"
        
    - name: Upload ISO artifact
      uses: actions/upload-artifact@v4
      with:
        name: minimal-shell-iso
        path: "*.iso"
        
    - name: Quick test with qemu
      run: |
        # 快速测试ISO是否可引导
        sudo apt-get install -y qemu-system-x86
        echo "Testing ISO with QEMU (10 seconds)..."
        
        # 使用timeout限制测试时间
        timeout 10 qemu-system-x86_64 \
          -cdrom *.iso \
          -m 256 \
          -display none \
          -serial stdio \
          -boot d 2>&1 | grep -i -E "(loading|boot|kernel|error|fail)" || echo "QEMU test completed"
