name: ISO


on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/ISO.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpine版本'
        required: true
        default: '3.20'
env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          grub2-common \
          grub-pc-bin \
          grub-efi-amd64-bin \
          xorriso \
          mtools \
          dosfstools \
          wget \
          qemu-system-x86
        
    - name: Create clean ISO directory
      run: |
        rm -rf iso_build
        mkdir -p iso_build
        
    - name: Prepare ISO filesystem
      run: |
        cd iso_build
        mkdir -p boot/grub kernel
        
        # 下载Alpine Linux内核
        cd kernel
        wget -q -O vmlinuz https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/netboot/vmlinuz-lts
        wget -q -O initrd.img https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/netboot/initramfs-lts
        cd ..
        
        echo "Kernel files:"
        ls -lh kernel/
        
    - name: Create GRUB configuration
      run: |
        cd iso_build
        
        cat > boot/grub/grub.cfg << 'EOF'
        set timeout=10
        set default=0

        menuentry "Minimal Live Shell" {
            echo "Loading Linux kernel..."
            linux /kernel/vmlinuz console=ttyS0 console=tty0 root=/dev/ram0 rw init=/bin/sh
            echo "Loading initial ramdisk..."
            initrd /kernel/initrd.img
        }
        EOF
        
        echo "GRUB config created"
        
    - name: Create BIOS boot image
      run: |
        cd iso_build
        
        # 复制BIOS引导镜像
        cp /usr/lib/grub/i386-pc/boot.img boot/grub/
        
        echo "BIOS boot image created"
        
    - name: Create EFI boot image
      run: |
        cd iso_build
        
        # 创建EFI系统分区镜像（16MB足够）
        dd if=/dev/zero of=boot/efiboot.img bs=1M count=16 status=none
        mkfs.vfat -F 32 boot/efiboot.img > /dev/null 2>&1
        
        # 挂载并设置EFI
        mkdir -p efi_mount
        sudo mount -o loop boot/efiboot.img efi_mount 2>/dev/null || true
        
        # 创建标准EFI目录结构
        sudo mkdir -p efi_mount/EFI/BOOT
        
        # 复制GRUB EFI文件
        if [ -f /usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed ]; then
            sudo cp /usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed \
                 efi_mount/EFI/BOOT/BOOTX64.EFI 2>/dev/null || true
        elif [ -f /usr/lib/grub/x86_64-efi/monolithic/grub.efi ]; then
            sudo cp /usr/lib/grub/x86_64-efi/monolithic/grub.efi \
                 efi_mount/EFI/BOOT/BOOTX64.EFI 2>/dev/null || true
        else
            echo "Installing grub-efi-amd64-signed..."
            sudo apt-get install -y grub-efi-amd64-signed > /dev/null 2>&1
            sudo cp /usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed \
                 efi_mount/EFI/BOOT/BOOTX64.EFI 2>/dev/null || true
        fi
        
        # 卸载
        sudo umount efi_mount 2>/dev/null || true
        rmdir efi_mount 2>/dev/null || true
        
        echo "EFI boot image created"
        
    - name: Build ISO with proper boot records
      run: |
        cd iso_build
        
        ISO_NAME="minimal-live-dualboot-$(date +%Y%m%d-%H%M).iso"
        
        echo "Building ISO with dual boot support..."
        echo "Working directory: $(pwd)"
        
        # 关键修正：使用单行命令或正确的多行语法
        xorriso -as mkisofs \
          -r \
          -V "MINIMAL_LIVE" \
          -J \
          -joliet-long \
          -iso-level 3 \
          -b boot/grub/boot.img \
          -no-emul-boot \
          -boot-load-size 4 \
          -boot-info-table \
          --efi-boot boot/efiboot.img \
          -efi-boot-part \
          --efi-boot-image \
          -o "../${ISO_NAME}" \
          .
        
        cd ..
        
        echo "=== ISO Build Complete ==="
        echo "File: ${ISO_NAME}"
        ls -lh "${ISO_NAME}"
        
    - name: Verify boot records
      run: |
        ISO_FILE=$(ls minimal-live-dualboot-*.iso 2>/dev/null | head -1)
        
        if [ -f "$ISO_FILE" ]; then
            echo "=== Checking ISO boot records ==="
            
            # 检查文件类型
            file "$ISO_FILE"
            
            # 使用xorriso检查引导信息
            xorriso -indev "$ISO_FILE" -toc 2>&1 | grep -i -E "(boot|eltorito|efi|system area)" || true
            
            echo "=== Verification Complete ==="
        else
            echo "ERROR: ISO file not found!"
            ls -la
        fi
        
    - name: Test BIOS boot with QEMU
      run: |
        ISO_FILE=$(ls minimal-live-dualboot-*.iso 2>/dev/null | head -1)
        
        if [ -f "$ISO_FILE" ]; then
            echo "Testing BIOS boot (5 seconds)..."
            
            # 安装qemu进行测试
            sudo apt-get install -y qemu-system-x86 > /dev/null 2>&1
            
            timeout 5 qemu-system-x86_64 \
              -cdrom "$ISO_FILE" \
              -m 256 \
              -boot d \
              -serial stdio \
              -display none \
              2>&1 | grep -i -E "(booting|loading|kernel|error|fail|warning)" | head -20 || true
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: minimal-live-dualboot
        path: "*.iso"
        if-no-files-found: error
