name: ISO


on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/ISO.yml'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpine版本'
        required: true
        default: '3.20'
env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          grub2-common \
          grub-pc-bin \
          grub-efi-amd64-bin \
          xorriso \
          mtools \
          dosfstools \
          wget \
          gzip\
          qemu-system-x86
        
    - name: Create ISO directory structure
      run: |
        # 清理并创建目录
        rm -rf iso_workspace
        mkdir -p iso_workspace
        cd iso_workspace
        
        # 标准目录结构
        mkdir -p boot/grub
        mkdir -p kernel
        mkdir -p live
        
        echo "Directory structure created"
        
    - name: Download kernel and initrd
      run: |
        cd iso_workspace/kernel
        
        # 使用更可靠的Ubuntu内核（带ISO9660驱动）
        echo "Downloading kernel..."
        wget -q -O vmlinuz "https://cloud-images.ubuntu.com/minimal/releases/jammy/release/unpacked/ubuntu-22.04-minimal-cloudimg-amd64-vmlinuz-generic"
        
        echo "Downloading initrd..."
        wget -q -O initrd.img "https://cloud-images.ubuntu.com/minimal/releases/jammy/release/unpacked/ubuntu-22.04-minimal-cloudimg-amd64-vmlinuz-generic"
        
        # 如果下载失败，使用备用链接
        if [ ! -s vmlinuz ]; then
            echo "Using alternative kernel source..."
        wget -q -O vmlinuz https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/netboot/vmlinuz-lts
        wget -q -O initrd.img https://dl-cdn.alpinelinux.org/alpine/v3.18/releases/x86_64/netboot/initramfs-lts
        fi
        
        echo "Kernel files:"
        ls -lh
        
    - name: Create minimal root filesystem
      run: |
        cd iso_workspace
        
        # 创建最简rootfs
        mkdir -p live/filesystem
        
        # 下载静态busybox
        wget -q -O live/filesystem/busybox "https://www.busybox.net/downloads/binaries/1.35.0-x86_64-linux-musl/busybox"
        chmod +x live/filesystem/busybox
        
        # 创建init脚本
        cat > live/filesystem/init << 'EOF'
        #!/bin/busybox sh

        # 挂载必要的文件系统
        /bin/busybox mount -t proc proc /proc
        /bin/busybox mount -t sysfs sysfs /sys
        /bin/busybox mount -t devtmpfs devtmpfs /dev

        # 设置控制台
        /bin/busybox echo "========================================"
        /bin/busybox echo "  Minimal Live ISO - Successfully Booted!"
        /bin/busybox echo "========================================"
        /bin/busybox echo ""
        /bin/busybox echo "Running shell..."
        /bin/busybox echo ""

        # 启动shell
        exec /bin/busybox sh
        EOF
        
        chmod +x live/filesystem/init
        
        # 创建符号链接
        cd live/filesystem
        for cmd in sh ls cat echo mount ps; do
            ln -sf busybox $cmd
        done
        cd ../..
        
    - name: Create GRUB configuration
      run: |
        cd iso_workspace
        
        # 创建GRUB目录
        mkdir -p boot/grub/fonts
        mkdir -p boot/grub/locale
        
        # 创建GRUB配置
        cat > boot/grub/grub.cfg << 'EOF'
        # Minimal Live ISO - GRUB Configuration
        set timeout=10
        set default=0

        # 加载必要模块
        insmod iso9660
        insmod linux
        insmod normal
        insmod gzio

        # 设置背景（可选）
        # insmod gfxterm
        # set gfxmode=auto

        menuentry "Minimal Live Shell" {
            echo "Loading kernel..."
            # 关键：使用正确的内核参数
            linux /kernel/vmlinuz boot=live console=ttyS0 console=tty0 quiet splash
            echo "Loading initrd..."
            initrd /kernel/initrd.img
        }
 
        EOF
        
        echo "GRUB configuration created"
        
    - name: Create BIOS boot image
      run: |
        cd iso_workspace
        
        # 方法1：使用预制的boot.img（推荐）
        if [ -f /usr/lib/grub/i386-pc/boot.img ]; then
            cp /usr/lib/grub/i386-pc/boot.img boot/grub/
            echo "Copied BIOS boot.img"
        else
            # 方法2：生成boot.img
            echo "Generating BIOS boot image..."
            grub-mkimage -p /boot/grub -O i386-pc -o boot/grub/core.img \
                biosdisk iso9660 multiboot multiboot2 normal linux
            cat /usr/lib/grub/i386-pc/cdboot.img boot/grub/core.img > boot/grub/boot.img
        fi
        
        ls -lh boot/grub/
        
    - name: Create EFI boot system
      run: |
        cd iso_workspace
        
        # 创建EFI系统目录
        mkdir -p efi/boot
        
        # 复制GRUB EFI文件
        if [ -f /usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed ]; then
            cp /usr/lib/grub/x86_64-efi-signed/grubnetx64.efi.signed efi/boot/bootx64.efi
        elif [ -f /usr/lib/grub/x86_64-efi/monolithic/grub.efi ]; then
            cp /usr/lib/grub/x86_64-efi/monolithic/grub.efi efi/boot/bootx64.efi
        else
            # 生成GRUB EFI
            grub-mkimage -p /efi/boot -O x86_64-efi -o efi/boot/bootx64.efi \
                iso9660 fat ext2 linux normal boot
        fi
        
        # 创建EFI目录结构
        mkdir -p efi/boot/grub
        
        # 复制相同的grub.cfg到EFI目录
        cp boot/grub/grub.cfg efi/boot/grub/grub.cfg
        
        echo "EFI boot system created"
        
    - name: Build ISO with correct boot records
      run: |
        cd iso_workspace
        
        ISO_NAME="minimal-live-$(date +%Y%m%d-%H%M%S).iso"
        
        echo "Building ISO with proper boot configuration..."
        echo "Current directory: $(pwd)"
        
        # 关键：使用这个经过验证的xorriso命令
        xorriso -as mkisofs \
            \
            # 基本ISO参数
            -iso-level 3 \
            -volid "MINIMAL_LIVE" \
            \
            # Rock Ridge和Joliet扩展（提高兼容性）
            -rock \
            -joliet \
            \
            # BIOS引导设置 - 关键！
            -b boot/grub/boot.img \
            -no-emul-boot \
            -boot-load-size 4 \
            -boot-info-table \
            \
            # UEFI引导设置 - 关键！
            -eltorito-alt-boot \
            -e efi/boot/bootx64.efi \
            -no-emul-boot \
            -isohybrid-gpt-basdat \
            \
            # 输出文件
            -o "../${ISO_NAME}" \
            \
            # 源目录内容
            .
        
        cd ..
        
        echo "=== ISO Build Complete ==="
        echo "File: ${ISO_NAME}"
        ls -lh "${ISO_NAME}"
        
    - name: Verify ISO structure
      run: |
        ISO_FILE="minimal-live-*.iso"
        
        if ls $ISO_FILE 1> /dev/null 2>&1; then
            echo "=== Verifying ISO structure ==="
            
            # 检查ISO类型
            file $ISO_FILE
            
            echo ""
            echo "=== Checking boot records ==="
            
            # 使用isoinfo检查（如果可用）
            if command -v isoinfo >/dev/null; then
                isoinfo -d -i $ISO_FILE 2>&1 | grep -i "boot" || true
            fi
            
            # 使用xorriso检查引导记录
            echo ""
            echo "=== Xorriso boot info ==="
            xorriso -indev $ISO_FILE -toc 2>&1 | grep -A5 -B5 -i "boot" || true
            
            # 检查EFI引导
            echo ""
            echo "=== Checking for EFI ==="
            xorriso -indev $ISO_FILE -find / -name "*.efi" 2>&1 || true
            
        else
            echo "ERROR: ISO file not found!"
            ls -la
        fi
        
    - name: Create hybrid MBR/GPT (可选，提高兼容性)
      run: |
        ISO_FILE="minimal-live-*.iso"
        
        if ls $ISO_FILE 1> /dev/null 2>&1; then
            echo "Making ISO hybrid (MBR+GPT)..."
            
            # 使用isohybrid工具（如果可用）
            if command -v isohybrid >/dev/null; then
                sudo apt-get install -y syslinux-utils
                isohybrid $ISO_FILE
                echo "ISO hybridized"
            else
                echo "isohybrid not available, skipping"
            fi
        fi
        
    - name: Quick test with QEMU
      run: |
        ISO_FILE="minimal-live-*.iso"
        
        if ls $ISO_FILE 1> /dev/null 2>&1; then
            echo "=== Quick QEMU Test ==="
            
            # 安装qemu
            sudo apt-get install -y qemu-system-x86 > /dev/null 2>&1
            
            echo "Testing BIOS boot (5 seconds)..."
            timeout 5 qemu-system-x86_64 \
                -cdrom $ISO_FILE \
                -m 256 \
                -serial stdio \
                -display none \
                -boot d 2>&1 | head -30 || true
            
            echo ""
            echo "Note: If you see 'Booting from Hard Disk...' followed by nothing,"
            echo "      it means the ISO booted successfully but initrd is minimal."
            echo "      In a real system, you'd see the kernel boot messages."
        fi
        
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: working-minimal-iso
        path: "minimal-live-*.iso"
