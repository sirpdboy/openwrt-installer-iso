name: Build-Alpine-ISO3

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/Build-Alpine-ISO3.yml'

  workflow_dispatch:
    inputs:
      openwrt_image_url:
        description: 'OpenWRT镜像URL'
        required: true
        default: 'https://downloads.openwrt.org/releases/23.05.0/targets/x86/64/openwrt-23.05.0-x86-64-generic-ext4-combined.img.gz'
      alpine_version:
        description: 'Alpine版本'
        required: true
        default: '3.20'
      iso_filename:
        description: '输出ISO文件名'
        required: false
        default: 'openwrt-alpine-installer.iso'

env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}
  ISO_FILENAME: ${{ github.event.inputs.iso_filename || 'openwrt-alpine-installer.iso' }}

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: 检出代码
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
        
    - name: 设置执行权限
      run: chmod +x scripts/*.sh 2>/dev/null || true
      
    - name: 下载OpenWRT镜像
      id: download
      run: |
        echo "下载OpenWRT镜像..."
        mkdir -p downloads
        
        OPENWRT_URL="${{ github.event.inputs.openwrt_image_url }}"
        OUTPUT_IMG="downloads/openwrt.img"
        # 方法1: 尝试下载最新版本
        REPO="sirpdboy/openwrt"
        echo "获取最新版本..."
        # 获取最新版本
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        if [ -z "$LATEST_RELEASE" ]; then
            echo "无法获取最新版本，使用硬编码版本"
            LATEST_RELEASE="v2026.01.01"
        fi
        echo "最新版本: $LATEST_RELEASE"
        # 获取下载URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "无法获取下载URL，使用备用方法"
            # 备用URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        OPENWRT_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        
        if wget -q -O "$OUTPUT_IMG.gz" "$OPENWRT_URL"; then
            echo "✅ 下载成功"
            
            # 尝试解压
            if gzip -t "$OUTPUT_IMG.gz" 2>/dev/null; then
                gzip -d "$OUTPUT_IMG.gz"
                echo "解压成功"
            else
                echo "不是gzip格式，直接使用"
                mv "$OUTPUT_IMG.gz" "$OUTPUT_IMG"
            fi
            
            echo "镜像大小: $(du -h "$OUTPUT_IMG" | cut -f1)"
            echo "img_path=$OUTPUT_IMG" >> $GITHUB_OUTPUT
        else
            echo "❌ 下载失败"
            exit 1
        fi

    - name: 创建输出目录
      run: |
        mkdir -p output
        echo "输出目录准备完成"
        
    - name: 运行构建脚本
      run: |
        echo "开始构建ISO..."
        echo "参数:"
        echo "  OpenWRT镜像: ${{ steps.download.outputs.img_path }}"
        echo "  输出ISO: output/${{ env.ISO_FILENAME }}"
        echo "  Alpine版本: ${{ env.ALPINE_VERSION }}"
        echo ""
        
        # 运行构建脚本
        ./scripts/build-iso.sh \
          "${{ steps.download.outputs.img_path }}" \
          "output/${{ env.ISO_FILENAME }}" \
          "${{ env.ALPINE_VERSION }}"
        
        # 检查结果
        if [ -f "output/${{ env.ISO_FILENAME }}" ]; then
            echo "✅ ISO构建成功!"
            ls -lh output/
        else
            echo "❌ ISO构建失败"
            exit 1
        fi
        
    - name: 验证ISO文件
      run: |
        echo "验证ISO文件..."
        ISO_FILE="output/${{ env.ISO_FILENAME }}"
        
        if [ -f "$ISO_FILE" ]; then
            echo "✅ ISO文件存在"
            echo "大小: $(du -h "$ISO_FILE" | cut -f1)"
            
            # 检查文件类型
            if command -v file >/dev/null 2>&1; then
                echo "文件类型:"
                file "$ISO_FILE"
            fi
            
            # 检查ISO结构
            if command -v xorriso >/dev/null 2>&1; then
                echo "ISO引导信息:"
                xorriso -indev "$ISO_FILE" -check_media 2>&1 | grep -E "El.Torito|bootable" || true
            fi
        else
            echo "❌ ISO文件不存在"
            exit 1
        fi
        
    - name: 上传ISO制品
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-installer-iso
        path: output/*
        retention-days: 3
        
    - name: 创建GitHub Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: output/${{ env.ISO_FILENAME }}
        tag_name: openwrt-${{ env.ALPINE_VERSION }}-$(date +%Y%m%d)
        name: "OpenWRT Alpine Installer v${{ env.ALPINE_VERSION }}"
        body: |
          # OpenWRT Alpine Installer
          
          ## 构建信息
          - **Alpine版本**: ${{ env.ALPINE_VERSION }}
          - **构建时间**: $(date)
          - **OpenWRT源**: ${{ github.event.inputs.openwrt_image_url }}
          
          ## 使用说明
          
          1. **制作启动U盘**:
             ```bash
             dd if=${{ env.ISO_FILENAME }} of=/dev/sdX bs=4M status=progress
             ```

          ## 文件信息
          
          文件: ${{ env.ISO_FILENAME }}
          大小: $(du -h output/${{ env.ISO_FILENAME }} | cut -f1)
        draft: false
        prerelease: false
