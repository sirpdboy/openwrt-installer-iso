name: Build OpenWRT ISO with Alpine

on:
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: true
        default: '3.20'
      openwrt_image_url:
        description: 'OpenWRTé•œåƒURL'
        required: false
        default: 'https://downloads.openwrt.org/releases/23.05.0/targets/x86/64/openwrt-23.05.0-x86-64-generic-ext4-combined.img.gz'

env:
  ALPINE_VERSION: ${{ github.event.inputs.alpine_version || '3.20' }}

jobs:
  build-iso:
    runs-on: ubuntu-latest
    
    steps:
    - name: æ£€æŸ¥ç¯å¢ƒ
      run: |
        echo "Alpineç‰ˆæœ¬: ${{ env.ALPINE_VERSION }}"
        echo "å·¥ä½œç›®å½•: $(pwd)"
        
    - name: å‡†å¤‡ç›®å½•
      run: |
        mkdir -p iso-output
        mkdir -p build-scripts
        
    - name: åˆ›å»ºæ­£ç¡®çš„Dockerfile
      run: |
        cat > Dockerfile.alpine-build << 'DOCKEREOF'
        # ä½¿ç”¨åŸºç¡€é•œåƒ
        FROM alpine:3.20
        
        # å®‰è£…åŸºç¡€å·¥å…·ï¼ˆå›ºå®šç‰ˆæœ¬ï¼Œä¸ä½¿ç”¨å˜é‡ï¼‰
        RUN apk update && apk add --no-cache \
            bash \
            git \
            curl \
            wget \
            sudo
        
        # å®‰è£…Alpineæ„å»ºå·¥å…·
        RUN apk add --no-cache \
            alpine-sdk \
            alpine-conf \
            syslinux \
            xorriso \
            squashfs-tools \
            grub \
            grub-efi \
            mtools \
            dosfstools \
            e2fsprogs \
            parted \
            lsblk
        
        # åˆ›å»ºæ„å»ºç”¨æˆ·
        RUN adduser -D -g "Alpine Builder" builder && \
            echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers
        
        USER builder
        WORKDIR /home/builder
        
        # è®¾ç½®ç¯å¢ƒ
        ENV HOME=/home/builder
        
        # å¤åˆ¶æ„å»ºè„šæœ¬
        COPY --chown=builder:builder build-scripts/ /home/builder/build-scripts/
        
        # è®¾ç½®å…¥å£
        ENTRYPOINT ["/bin/bash", "/home/builder/build-scripts/build-iso.sh"]
        DOCKEREOF
        
        echo "âœ… Dockerfile åˆ›å»ºå®Œæˆ"

    - name: åˆ›å»ºæ„å»ºè„šæœ¬
      run: |
        # åˆ›å»ºä¸»æ„å»ºè„šæœ¬
        cat > build-scripts/build-iso.sh << 'SCRIPTEOF'
        #!/bin/bash
        set -e
        
        echo "================================================"
        echo "  OpenWRT ISO Builder"
        echo "================================================"
        echo ""
        
        # è·å–Alpineç‰ˆæœ¬ï¼ˆä»ç¯å¢ƒå˜é‡æˆ–å‚æ•°ï¼‰
        ALPINE_VERSION=${1:-"3.20"}
        echo "ä½¿ç”¨ Alpine ç‰ˆæœ¬: $ALPINE_VERSION"
        
        # æ£€æŸ¥å¿…è¦å·¥å…·
        echo "æ£€æŸ¥å·¥å…·..."
        for cmd in git mkimage.sh xorriso; do
            if command -v $cmd >/dev/null 2>&1; then
                echo "âœ… $cmd å¯ç”¨"
            else
                echo "âš ï¸  $cmd æœªæ‰¾åˆ°"
            fi
        done
        
        # è®¾ç½®å·¥ä½œç›®å½•
        WORKDIR=/home/builder/work
        mkdir -p $WORKDIR
        cd $WORKDIR
        
        # å…‹éš† aports ä»“åº“
        if [ ! -d "aports" ]; then
            echo "å…‹éš† aports ä»“åº“..."
            git clone --depth 1 --branch v$ALPINE_VERSION \
                https://gitlab.alpinelinux.org/alpine/aports.git
        fi
        
        cd aports
        
        # åˆ›å»ºOpenWRTå®‰è£…profile
        echo "åˆ›å»ºOpenWRTå®‰è£…profile..."
        
        # 1. åˆ›å»ºprofileæ–‡ä»¶
        cat > scripts/mkimg.openwrt.sh << 'PROFILEEOF'
        profile_openwrt() {
            profile_standard
            kernel_cmdline="console=tty0 console=ttyS0,115200"
            syslinux_serial="0 115200"
            
            # åˆ›å»ºoverlayè„šæœ¬
            cat > scripts/genapkovl-openwrt.sh << 'OVERLAYEOF'
        #!/bin/sh
        
        set -e
        
        # åˆ›å»ºä¸´æ—¶ç›®å½•
        tmp="${ROOT}/tmp/overlay"
        mkdir -p "$tmp"/etc
        mkdir -p "$tmp"/var
        
        # åˆ›å»ºæ¬¢è¿ä¿¡æ¯
        cat > "$tmp"/etc/issue << 'ISSUEEOF'
        ========================================
              OpenWRT Alpine Installer
        ========================================
        
        ä»å¯åŠ¨èœå•ä¸­é€‰æ‹© "Install OpenWRT"
        
        ISSUEEOF
        
        # æ‰“åŒ…overlay
        ( cd "$tmp" && tar -c -f "${ROOT}"/tmp/overlay.tar . )
        OVERLAYEOF
            
            chmod +x scripts/genapkovl-openwrt.sh
            apkovl="genapkovl-openwrt.sh"
        }
        PROFILEEOF
        
        # 2. æ„å»ºISO
        echo "å¼€å§‹æ„å»ºISO..."
        
        # åˆ›å»ºè¾“å‡ºç›®å½•
        OUTPUT_DIR=/output
        mkdir -p $OUTPUT_DIR
        
        # è¿è¡Œmkimage
        ./scripts/mkimage.sh \
            --tag "$ALPINE_VERSION" \
            --outdir "$OUTPUT_DIR" \
            --arch x86_64 \
            --hostkeys \
            --repository "http://dl-cdn.alpinelinux.org/alpine/v$ALPINE_VERSION/main" \
            --repository "http://dl-cdn.alpinelinux.org/alpine/v$ALPINE_VERSION/community" \
            --profile openwrt
        
        # æ£€æŸ¥ç»“æœ
        if ls $OUTPUT_DIR/*.iso 1>/dev/null 2>&1; then
            ISO_FILE=$(ls $OUTPUT_DIR/*.iso)
            echo ""
            echo "âœ… ISO æ„å»ºæˆåŠŸ!"
            echo "æ–‡ä»¶: $ISO_FILE"
            echo "å¤§å°: $(du -h "$ISO_FILE" | cut -f1)"
            
            # é‡å‘½å
            NEW_NAME="openwrt-alpine-$ALPINE_VERSION-$(date +%Y%m%d).iso"
            mv "$ISO_FILE" "$OUTPUT_DIR/$NEW_NAME"
            echo "é‡å‘½åä¸º: $NEW_NAME"
        else
            echo "âŒ ISO æ„å»ºå¤±è´¥"
            exit 1
        fi
        
        echo ""
        echo "ğŸ‰ æ„å»ºå®Œæˆ!"
        SCRIPTEOF
        
        chmod +x build-scripts/build-iso.sh
        
        # åˆ›å»ºæµ‹è¯•è„šæœ¬
        cat > build-scripts/test-env.sh << 'TESTEOF'
        #!/bin/bash
        echo "æµ‹è¯•ç¯å¢ƒ..."
        echo "ç”¨æˆ·: $(whoami)"
        echo "ç›®å½•: $(pwd)"
        echo "å·¥å…·æ£€æŸ¥:"
        which git && echo "âœ… git"
        which mkimage.sh || echo "âš ï¸  mkimage.sh"
        which xorriso && echo "âœ… xorriso"
        TESTEOF
        
        chmod +x build-scripts/test-env.sh

    - name: æ„å»ºDockeré•œåƒ
      run: |
        echo "æ„å»ºDockeré•œåƒ..."
        docker build -t alpine-openwrt-builder -f Dockerfile.alpine-build .
        
        echo "æµ‹è¯•é•œåƒ..."
        docker run --rm alpine-openwrt-builder /home/builder/build-scripts/test-env.sh

    - name: ä¸‹è½½OpenWRTé•œåƒ
      run: |
        echo "ä¸‹è½½OpenWRTé•œåƒ..."
        
        # OPENWRT_URL="${{ github.event.inputs.openwrt_image_url }}"
        # æ–¹æ³•1: å°è¯•ä¸‹è½½æœ€æ–°ç‰ˆæœ¬
        REPO="sirpdboy/openwrt"
        echo "è·å–æœ€æ–°ç‰ˆæœ¬..."
        # è·å–æœ€æ–°ç‰ˆæœ¬
        LATEST_RELEASE=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
        if [ -z "$LATEST_RELEASE" ]; then
            echo "æ— æ³•è·å–æœ€æ–°ç‰ˆæœ¬ï¼Œä½¿ç”¨ç¡¬ç¼–ç ç‰ˆæœ¬"
            LATEST_RELEASE="v2026.01.01"
        fi
        echo "æœ€æ–°ç‰ˆæœ¬: $LATEST_RELEASE"
        # è·å–ä¸‹è½½URL
        DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$LATEST_RELEASE" | \
              jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url' 2>/dev/null || echo "")
        if [ -z "$DOWNLOAD_URLS" ]; then
            echo "æ— æ³•è·å–ä¸‹è½½URLï¼Œä½¿ç”¨å¤‡ç”¨æ–¹æ³•"
            # å¤‡ç”¨URL
            DOWNLOAD_URLS="https://github.com/sirpdboy/openwrt/releases/download/v2024.09.01/2024.09.01-x86-64-generic-squashfs-combined.img.gz"
        fi
        
        OPENWRT_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
        mkdir -p custom-overlay/images
        
        if [ -n "$OPENWRT_URL" ] && [ "$OPENWRT_URL" != "none" ]; then
            echo "ä¸‹è½½: $OPENWRT_URL"
            if wget -q -O custom-overlay/images/openwrt.img.gz "$OPENWRT_URL"; then
                echo "ä¸‹è½½æˆåŠŸ"
                # å°è¯•è§£å‹
                if gzip -t custom-overlay/images/openwrt.img.gz 2>/dev/null; then
                    gzip -d custom-overlay/images/openwrt.img.gz
                    echo "è§£å‹æˆåŠŸ"
                else
                    echo "ä¸æ˜¯gzipæ ¼å¼ï¼Œç›´æ¥ä½¿ç”¨"
                    mv custom-overlay/images/openwrt.img.gz custom-overlay/images/openwrt.img
                fi
                echo "é•œåƒå¤§å°: $(du -h custom-overlay/images/openwrt.img | cut -f1)"
            else
                echo "ä¸‹è½½å¤±è´¥ï¼Œåˆ›å»ºæµ‹è¯•æ–‡ä»¶"
                dd if=/dev/zero of=custom-overlay/images/openwrt.img bs=1M count=50
            fi
        else
            echo "æœªæä¾›URLï¼Œåˆ›å»ºæµ‹è¯•æ–‡ä»¶"
            dd if=/dev/zero of=custom-overlay/images/openwrt.img bs=1M count=50
        fi
        
        # åˆ›å»ºç®€å•çš„å®‰è£…è„šæœ¬
        cat > custom-overlay/install.sh << 'INSTALLEOF'
        #!/bin/sh
        echo "OpenWRTå®‰è£…è„šæœ¬"
        echo "é•œåƒä½ç½®: /images/openwrt.img"
        INSTALLEOF
        chmod +x custom-overlay/install.sh

    - name: è¿è¡Œæ„å»º
      run: |
        echo "è¿è¡Œæ„å»ºå®¹å™¨..."
        
        docker run --rm \
          -v $(pwd)/custom-overlay:/custom:ro \
          -v $(pwd)/iso-output:/output:rw \
          -e ALPINE_VERSION="${{ env.ALPINE_VERSION }}" \
          alpine-openwrt-builder \
          /home/builder/build-scripts/build-iso.sh "${{ env.ALPINE_VERSION }}"
        
        # æ£€æŸ¥è¾“å‡º
        echo ""
        echo "æ£€æŸ¥è¾“å‡ºæ–‡ä»¶..."
        if ls iso-output/*.iso 1>/dev/null 2>&1; then
            echo "âœ… ISOæ–‡ä»¶:"
            ls -lh iso-output/
            
            # éªŒè¯ISO
            echo ""
            echo "éªŒè¯ISO..."
            if command -v file >/dev/null; then
                file iso-output/*.iso
            fi
        else
            echo "âŒ æ²¡æœ‰ç”ŸæˆISOæ–‡ä»¶"
            exit 1
        fi

    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-alpine-iso
        path: iso-output/*.iso
        retention-days: 7
        
    - name: åˆ›å»ºRelease
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        files: iso-output/*.iso
        tag_name: openwrt-${{ github.run_number }}
        name: "OpenWRT Alpine Installer"
        body: |
          # OpenWRT Alpine Installer ISO
          
          ç‰ˆæœ¬: ${{ env.ALPINE_VERSION }}
          æ„å»ºæ—¶é—´: $(date)
          
          ä½¿ç”¨è¯´æ˜:
          1. å†™å…¥Uç›˜: `dd if=*.iso of=/dev/sdX bs=4M status=progress`
          2. ä»Uç›˜å¯åŠ¨
          3. é€‰æ‹©å®‰è£…é€‰é¡¹
        draft: false
        prerelease: false
