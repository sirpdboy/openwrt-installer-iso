name: build-iso-tinycore

on:
  push:
    branches: [ main, master ]
    paths:
      - 'build-iso-tinycore.sh'
      - '.github/workflows/build-iso-tinycore.yml'
  workflow_dispatch:
    inputs:
      alpine_version:
        description: 'Alpineç‰ˆæœ¬'
        required: false
        default: '3.20'

jobs:
  build-small:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
        wget \
        curl \
        xorriso \
        syslinux \
        isolinux \
        syslinux-common \
        mtools \
        dosfstools \
        squashfs-tools \
        e2fsprogs \
        parted \
        gdisk \
        jq \
        grub-efi-amd64-bin \
        grub-pc-bin \
        grub-common \
        grub2-common \
        file \
        cpio \
        gzip \
        genisoimage
        
        mkdir -p assets
        cd assets
        echo "ROOTDIR=$PWD" >> $GITHUB_ENV
    - name: Download OpenWRT image
      run: |
        # ä½¿ç”¨ä½ çš„ä¸‹è½½è„šæœ¬æˆ–ç›´æ¥ä¸‹è½½
        if [ -f scripts/download-image.sh ]; then
          chmod +x scripts/download-image.sh
          ./scripts/download-image.sh
        else
          echo "ä¸‹è½½OpenWRTé•œåƒ..."
          REPO="sirpdboy/openwrt"
          TAG=$(curl -sL "https://api.github.com/repos/$REPO/releases/latest" | jq -r '.tag_name // empty')
          DOWNLOAD_URLS=$(curl -sL "https://api.github.com/repos/$REPO/releases/tags/$TAG" | \
                jq -r '.assets[] | select(.name | endswith("img.gz")) | .browser_download_url')
          FIRST_URL=$(echo "$DOWNLOAD_URLS" | head -n1)
          echo "ä¸‹è½½: $FIRST_URL"
          wget -q $FIRST_URL  -O assets/ezopwrt.img.gz
           if [ ! -f "assets/ezopwrt.img.gz" ]; then
             curl -L -o "$OUTPUT_FILE"  --progress-bar --retry 3 "$FIRST_URL" 
           fi
        
           if [ $? -eq 0 ]; then
               echo "âœ… ä¸‹è½½å®Œæˆ"
               gzip -d assets/ezopwrt.img.gz
            fi
            
        fi
        echo "âœ… é•œåƒå¤§å°: $(stat -c%s assets/ezopwrt.img | numfmt --to=iec)"
    
    - name: Create output directory
      run: |
        mkdir -p $ROOTDIR/output
        chmod 777 $ROOTDIR/output
    
    - name: build-iso-tinycore
      run: |
        chmod +x build-iso-tinycore.sh
        ./build-iso-tinycore.sh \
          "$ROOTDIR/ezopwrt.img" \
          "$ROOTDIR/output" \
          "openwrt-tiny-installer.iso"
      
        echo "ISOæ„å»ºå®Œæˆ:"
        ls -lh $ROOTDIR/output
    
    
    - name: ä¸Šä¼ åˆ¶å“
      uses: actions/upload-artifact@v4
      with:
        name: openwrt-tiny-installer
        path: assets/output/*.iso
        retention-days: 30
        if-no-files-found: error
    
    - name: åˆ›å»ºå‘å¸ƒ
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        files: assets/output/*.iso
        body: |
          # ğŸ¯ OpenWRT å¾®å‹å®‰è£…å™¨
          
          ## ğŸ“Š ç‰¹æ€§
          - **è¶…å°ä½“ç§¯**: < 50MB
          - **åŒå¼•å¯¼**: BIOS + UEFI æ”¯æŒ
          - **æç®€è®¾è®¡**: ä»…åŒ…å«å¿…è¦ç»„ä»¶
          - **å¿«é€Ÿå¯åŠ¨**: ç§’çº§å¯åŠ¨æ—¶é—´
          - **è‡ªåŠ¨å®‰è£…**: ç®€å•æ˜“ç”¨
          
          ## ğŸ› ï¸ æŠ€æœ¯è§„æ ¼
          - **å†…æ ¸**: TinyCore Linux å¾®å†…æ ¸ (~5MB)
          - **æ ¹æ–‡ä»¶ç³»ç»Ÿ**: BusyBox + æç®€initramfs
          - **å¼•å¯¼**: SYSLINUX (BIOS) + GRUB (UEFI)
          - **æ€»å¤§å°**: é€šå¸¸ < 50MB
          
          ## ğŸ“– ä½¿ç”¨æ–¹æ³•
          ```bash
          # å†™å…¥Uç›˜
          dd if=openwrt-tiny-installer.iso of=/dev/sdX bs=4M status=progress
          
          # æˆ–ä½¿ç”¨å›¾å½¢å·¥å…·
          # - Etcher: https://www.balena.io/etcher/
          # - Ventoy: https://www.ventoy.net/
          ```
          
          ## âš ï¸ æ³¨æ„äº‹é¡¹
          1. å¦‚æœå†…æ ¸æ–‡ä»¶è¾ƒå°ï¼Œå¯èƒ½éœ€è¦æ‰‹åŠ¨æ›¿æ¢
          2. å®‰è£…ä¼šæ“¦é™¤ç›®æ ‡ç£ç›˜æ‰€æœ‰æ•°æ®
          3. ç¡®ä¿å¤‡ä»½é‡è¦æ•°æ®
          
          ## ğŸ”§ å†…æ ¸æ›¿æ¢æ–¹æ³•
          å¦‚æœå†…æ ¸æ— æ³•å¼•å¯¼ï¼Œæ›¿æ¢æ–¹æ³•:
          ```bash
          # ä¸‹è½½TinyCoreå†…æ ¸
          wget https://github.com/tinycorelinux/Core-scripts/raw/master/vmlinuz64
          
          # æ›¿æ¢ISOä¸­çš„å†…æ ¸
          xorriso -indev openwrt-tiny-installer.iso \
            -boot_image any keep \
            -append_partition 2 0xef vmlinuz64 \
            -outdev new.iso
          ```
          
          ---
          *ç”±GitHub Actionsè‡ªåŠ¨æ„å»º*
